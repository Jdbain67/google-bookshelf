:imagesdir: images

:toc: left

= Bookshelf App for Java

== Overview

The Bookshelf app is a sample web app written in Java that shows how to use a variety of Google Cloud Platform products, including:

- Google App Engine flexible environment
- Google Cloud SQL
- Google Cloud Datastore
- Google Cloud Storage
- Google Compute Engine

This tutorial explores the Bookshelf app in detail, and discusses how each feature of the app is implemented using familiar technologies and services provided by Cloud Platform.

The Bookshelf app is based on the https://wikipedia.org/wiki/Java_servlet[javax.servlet] web application framework and
uses https://wikipedia.org/wiki/JavaServer_Pages[JavaServer Pages].
The Bookshelf sample app uses Servlets because of their simplicity and ease of use, however the concepts and
technologies explored are applicable regardless of which framework you use. You could implement this app in another web
application framework of your choice, for example, http://projects.spring.io/spring-boot/[Spring Boot]) (https://github.com/GoogleCloudPlatform/getting-started-java/tree/master/helloworld-springboot[sample]).

image::bookshelf-app-3.png[]

The Bookshelf sample app stores a collection of book titles. Anyone who has access to the app can add books to the list. The sample app offers these features:

- Users can view the list of books, add books to the list, and remove books from the list.
- Users can edit book details.
- Users can upload cover images for books.
- Users can log in with their Google accounts and view the books that they have added to the list.

=== Objectives

- Clone or download the sample app.
- Build the app and run it on your local machine.
- Deploy the app to App Engine.
- Walk through the sample code.
- Learn how the app stores structured data.
- Learn how the app stores binary data in Google Cloud Storage.
- Learn how the app authenticates users.
- Learn how the app creates event logs that are visible in the Google Cloud Platform Console.

=== Costs

This tutorial uses billable components of Cloud Platform including Google Compute Engine.

This tutorial has several steps, and each step is documented on its own page. The final page of the tutorial includes
instructions for cleaning up resources, so you won't continue to be billed for Cloud Platform services.
If you decide not to complete all the steps of the tutorial,
see the https://cloud.google.com/java/getting-started/logging-application-events#clean-up[cleanup instructions] on the final page.

=== Before you begin

1. Use the Cloud Platform Console to set up your Google Cloud Platform project:
    * Create a new Cloud Platform project, and then create an App Engine application and enable billing in that project:
    https://console.cloud.google.com/projectselector/appengine/create?lang=flex_java&st=true&_ga=1.20629880.1963584502.1488379440[GO TO APP ENGINE]
    * Enable the Cloud Datastore, Cloud Pub/Sub, Cloud Storage JSON, Stackdriver Logging, and Google+ APIs.
    https://console.cloud.google.com/flows/enableapi?apiid=datastore.googleapis.com,datastore,pubsub,storage_api,logging,plus,sqladmin.googleapis.com&redirect=https://console.cloud.google.com&_ga=1.20629880.1963584502.1488379440[ENABLE THE APIS]
2. To deploy a Java app to App Engine, you must first setup your environment, see https://cloud.google.com/appengine/docs/flexible/java/using-maven[Using Apache Maven and the App Engine Plugin] for details.
3. Download, install, and initialize the Google Cloud SDK:
https://cloud.google.com/sdk/docs/[DOWNLOAD THE SDK]
4. Acquire local credentials for authenticating with Google Cloud Platform services:   
`gcloud beta auth application-default login`
5. Verify that your default project is correct:  
`gcloud config list`  
If the project ID listed in the output is not the project that you intended to use for this tutorial, set the project by entering this command:  
`gcloud config set project [YOUR_PROJECT_ID]`
where [YOUR_PROJECT_ID] is the ID of the project you created or chose to use for this tutorial.

NOTE: You can create Google Cloud SDK configurations to set configuration properties like a Cloud Platform project ID, and then quickly switch between those configurations each time you use the gcloud tool, see Managing Cloud SDK Configurations for more information.

6. Clone the sample repository:  
`git clone https://github.com/GoogleCloudPlatform/getting-started-java.git` 

Alternatively, you can https://github.com/GoogleCloudPlatform/getting-started-java/archive/master.zip[download the sample] as a zip file and extract it.

This tutorial assumes that you are familiar with Java and that you have http://www.oracle.com/technetwork/java/javase/downloads/[Java 8] and http://maven.apache.org/[Maven] installed.

=== Tutorial structure

The Bookshelf tutorial has several parts that demonstrate how the sample app uses various Cloud Platform services.

The forms part of the tutorial demonstrates how the app uses web forms to to receive and store book information.

The structured data part of the tutorial demonstrates how the sample app stores book information in a SQL or NoSQL database. The app's web page displays a form where the user can enter the title, author, description, and publication date of a book. For each book entered, the app stores this information in a database, so it can be retrieved later for viewing or editing. For this step of the tutorial, you have your choice of two databases: Cloud Datastore or Cloud SQL. After you complete this step with one of the databases, you can move on to the next step.

The Cloud Storage part of the tutorial demonstrates how the sample app stores binary data in Cloud Storage. On the app's web page, the user can specify a cover image for each book. The app stores the cover images in a Cloud Storage bucket.

The authorization part of the tutorial demonstrates how the app provides a sign-in flow for the user. When a user is signed in, any books entered are associated with the individual user. Signed-in users see only their own books.

The logging part of the tutorial demonstrates how the app writes logs that become visible in the Google Cloud Platform Console. Logs of this type can provide diagnostic information during app development.

== Using Forms with Java

This part of the Bookshelf tutorial for Java shows how to access form data from Servlets.

This page is part of a multi-page tutorial. To start from the beginning and see instructions for setting up, go to https://cloud.google.com/java/getting-started/tutorial-app[Java Bookshelf App].

=== Running the app on your local machine

To run the app locally:

1. In the `getting-started-java/bookshelf/2-structured-data` directory, enter this command to start a local web server:  
`mvn -Plocal clean jetty:run-exploded -DprojectID=[YOUR-PROJECT-ID]`
2. In your web browser, navigate to http://localhost:8080[http://localhost:8080]

=== Deploying the app to the App Engine flexible environment

1. Enter this command to deploy the app:  
`mvn appengine:deploy -DprojectID=YOUR-PROJECT-ID`
2. In your web browser, enter this address. Replace `[YOUR_PROJECT_ID]` with your project ID:  
`https://[YOUR_PROJECT_ID].appspot-preview.com`  
If you update your app, you can deploy the updated version by entering the same command you used to deploy the app the first time. The new deployment creates a new version of your app and promotes it to the default version. The older versions of your app remain, as do their associated VM instances. Be aware that all of these app versions and VM instances are billable resources.

You can reduce costs by deleting the non-default versions of your app.

To delete an app version:

1. In the Cloud Platform Console, go to the App Engine Versions page.  
https://console.cloud.google.com/appengine/versions?_ga=1.17491577.1963584502.1488379440[GO TO THE VERSIONS PAGE]
2. Click the checkbox next to the non-default app version you want to delete.  
**Note: The only way to delete the default version of your App Engine app is to delete your project. You can, however, stop the default version in the Cloud Platform Console. This will shut down all instances associated with the version. You can restart these instances later if needed.
You can overwrite the default version of your app by redeploying the app.**
3. Click the **Delete** button at the top of the page to delete the app version.

For complete information about cleaning up billable resources, see the Cleaning up section in the final step of this tutorial.

=== Handling user submissions with forms
The add/edit form allows users to add and edit book submissions within the app.

image::add-edit-form.png[]

When the user's browser requests `/create`, the Servlet Container Engine loads the `CreateBookServlet` and calls the `doGet` method. Then the request is forwarded to the `/base.jsp` servlet, which includes the `/form.jsp` servlet. After the user submits the form, the doPost method of `CreateBookServlet` is called.

In `CreateBookServlet.java`, there are two annotations. The `@MultipartConfig` annotation tells the Jetty Servlet container that the app uses `multipart/form-data MIME type`. for form data. The `@WebServlet` annotation identifies the class as a Servlet and specifies addional attributes. In this case, the Servlet has a `name` of `create` and a `urlPattern` of `/create`. Additional parameters include `asyncSupported`, which specifies that the container Servlet can process requests asyncronously, and `loadOnStartup`, which tells the container to load the servlet and execute its `init() method:

[source, java]
.bookshelf/2-structured-data/src/main/java/com/example/getstarted/basicactions/CreateBookServlet.java`
----
@MultipartConfig
@WebServlet(name = "create", urlPatterns = {"/create"})
----


The doGet method processes the request for a form and sets up attributes to be used by the JSP file:


[source, java]
./bookshelf/2-structured-data/src/main/java/com/example/getstarted/basicactions/CreateBookServlet.java
----
@Override
public void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException,
    IOException {
  req.setAttribute("action", "Add");          // Part of the Header in form.jsp
  req.setAttribute("destination", "create");  // The urlPattern to invoke (this Servlet)
  req.setAttribute("page", "form");           // Tells base.jsp to include form.jsp
  req.getRequestDispatcher("/base.jsp").forward(req, resp);
}
----

The base.jsp file serves as the foundation for the app's HTML pages. It starts by including the https://jstl.java.net/[JSP Standard Tag Library]. http://docs.oracle.com/javaee/5/jstl/1.1/docs/tlddocs/c/tld-summary.html[JSTL core tags] are identified by tags starting with <c: and provide Variable, Flow control, URL management and miscellaneous support.
http://docs.oracle.com/javaee/5/jstl/1.1/docs/tlddocs/fn/tld-summary.html[JSTL functions] are identified by tags starting with `<fn:` and provide Collections and String manipulation libraries. Here is a summary of JSTL tags used by the Bookshelf Application:

|===
| JSTL tag	  | Description
| `<c:if …`	| Evaluate expression test and include content if true.
| `<c:choose>` | Conditional tag that establishes context for `c:when` and `c:otherwise`
| `<c:when ...` | Include content if test is true.
| `<c:otherwise>	If c:when is not true, include this content.
| `<c:import url="" />` | Include the contents of the url within the page.
| `<c:out value="" />` | Evaluate the expression for value and display an encoded version.
| `${fn:escapeXml()}` | Escape special characters for webpages.
|===


[source, jsp]
./bookshelf/2-structured-data/src/main/webapp/base.jsp
----
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<html lang="en">
  <head>
    <title>Bookshelf - Java on Google Cloud Platform</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  </head>
  <body>
    <div class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <div class="navbar-brand">Bookshelf</div>
        </div>
        <ul class="nav navbar-nav">
          <li><a href="/">Books</a></li>
          <c:if test="${isAuthConfigured}"><li><a href="/books/mine">My Books</a></li></c:if>
        </ul>
        <p class="navbar-text navbar-right">
          <c:choose>
          <c:when test="${not empty token}">
          <!-- using pageContext requires jsp-api artifact in pom.xml -->
          <a href="/logout">
            <c:if test="${not empty userImageUrl}">
              <img class="img-circle" src="${fn:escapeXml(userImageUrl)}" width="24">
            </c:if>
            ${fn:escapeXml(userEmail)}
          </a>
          </c:when>
          <c:when test="${isAuthConfigured}">
          <a href="/login">Login</a>
          </c:when>
          </c:choose>
        </p>
      </div>
    </div>
    <c:import url="/${page}.jsp" />
  </body>
</html>
----
The HTML form is created using http://www.ibm.com/developerworks/java/tutorials/j-introjsp/j-introjsp.html[JavaServer Pages],
which is like a Java template engine, but runs as Servlets. The following JSP code specifies that the form include text input fields for Title, Author, Date Published, Description, Cover Image, and a Save button:

[source, jsp]
./bookshelf/2-structured-data/src/main/webapp/form.jsp
----
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<div class="container">
  <h3>
    <c:out value="${action}" /> book
  </h3>

  <form method="POST" action="${destination}" enctype="multipart/form-data">

    <div class="form-group">
      <label for="title">Title</label>
      <input type="text" name="title" id="title" value="${fn:escapeXml(book.title)}" class="form-control" />
    </div>

    <div class="form-group">
      <label for="author">Author</label>
      <input type="text" name="author" id="author" value="${fn:escapeXml(book.author)}" class="form-control" />
    </div>

    <div class="form-group">
      <label for="publishedDate">Date Published</label>
      <input type="text" name="publishedDate" id="publishedDate" value="${fn:escapeXml(book.publishedDate)}" class="form-control" />
    </div>

    <div class="form-group">
      <label for="description">Description</label>
      <textarea name="description" id="description" class="form-control">${fn:escapeXml(book.description)}</textarea>
    </div>

    <div class="form-group ${isCloudStorageConfigured ? '' : 'hidden'}">
      <label for="image">Cover Image</label>
      <input type="file" name="file" id="file" class="form-control" />
    </div>

    <div class="form-group hidden">
      <label for="imageUrl">Cover Image URL</label>
      <input type="hidden" name="id" value="${book.id}" />
      <input type="text" name="imageUrl" id="imageUrl" value="${fn:escapeXml(book.imageUrl)}" class="form-control" />
    </div>

    <button type="submit" class="btn btn-success">Save</button>
  </form>
</div>
----

=== Form submission

The doPost method creates a `CloudStorageHelper` and a `BookDao`. The form parameters are accessed by the `req.getParameter()` functions, and the page is redirected to /read to see what we just wrote. Session access and book creation will be discussed later:

[source, java]
./bookshelf/2-structured-data/src/main/java/com/example/getstarted/basicactions/CreateBookServlet.java
----
@Override
public void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException,
    IOException {
  BookDao dao = (BookDao) this.getServletContext().getAttribute("dao");
  Book book = new Book.Builder()
      .author(req.getParameter("author"))   // form parameter
      .description(req.getParameter("description"))
      .publishedDate(req.getParameter("publishedDate"))
      .title(req.getParameter("title"))
      .imageUrl(null)
      .build();
  try {
    Long id = dao.createBook(book);
    resp.sendRedirect("/read?id=" + id.toString());   // read what we just wrote
  } catch (Exception e) {
    throw new ServletException("Error creating book", e);
  }
}
----

== Using Cloud Datastore with Java

This part of the Bookshelf tutorial for Java shows how to create, read, update, and delete structured data in https://cloud.google.com/datastore/docs/concepts/overview[Google Cloud Datastore].

This page is part of a multi-page tutorial. To start from the beginning and see instructions for setting up, go to https://cloud.google.com/java/getting-started/tutorial-app[Java Bookshelf App].

=== Configuring settings

The `pom.xml` holds configuration information for all parts of the Bookshelf tutorial. For this part of the tutorial, you don't have to add any configuration information. The only requirement is that the `bookshelf.storageType` property be set to `datastore`, which is already done for you.

=== Running the app on your local machine

To run the app locally:

1. In the getting-started-java/bookshelf/bookshelf directory, enter this command to start a local web server:

`mvn -Plocal clean jetty:run-exploded -DprojectID=[YOUR-PROJECT-ID]`

2. In your web browser, navigate to http://localhost:8080
Now you can browse the app's web pages and add, edit, and delete books.

Now you can browse the app’s web pages and add, edit and delete books. 

=== Deploying the app to the App Engine flexible environment

1. Enter this command to deploy the app:  
`mvn appengine:deploy -DprojectID=YOUR-PROJECT-ID`
2. In your web browser, enter this address. Replace [YOUR_PROJECT_ID] with your project ID:  
`https://[YOUR_PROJECT_ID].appspot-preview.com`

If you update your app, you can deploy the updated version by entering the same command you used to deploy the app the first time. The new deployment creates a new version of your app and promotes it to the default version. The older versions of your app remain, as do their associated VM instances. Be aware that all of these app versions and VM instances are billable resources.

You can reduce costs by deleting the non-default versions of your app.

To delete an app version:

1. In the Cloud Platform Console, go to the App Engine Versions page.  
https://console.cloud.google.com/appengine/versions?_ga=1.91866586.1963584502.1488379440[GO TO THE VERSIONS PAGE]
2. Click the checkbox next to the non-default app version you want to delete.
**Note: The only way to delete the default version of your App Engine app is to delete your project. You can, however, stop the default version in the Cloud Platform Console. This will shut down all instances associated with the version. You can restart these instances later if needed.  
You can overwrite the default version of your app by redeploying the app.**
3. Click the **Delete** button at the top of the page to delete the app version.

For complete information about cleaning up billable resources, see the Cleaning up section in the final step of this tutorial.

=== Application structure

The following diagram shows the application's components and how they fit together.

image::java-datastore.png[]

=== Understanding the code

This section walks you through the application code and explains how it works.

=== Interacting with Cloud Datastore

The app uses an authorized Datastore service object to interact with Cloud Datastore. This is a heavyweight object, as it has exchanged credentials for a token that it can use to access the Datastore APIs. The app also creates a KeyFactory obect of kind "Book". The book is the only kind of data that this app stores; in general, however, you can store as many kinds of data as you like.
Cloud Datastore supports a https://cloud.google.com/datastore/docs/concepts/entities#properties_and_value_types[rich assortment of datatypes].


[source, java]
./bookshelf/2-structured-data/src/main/java/com/example/getstarted/daos/DatastoreDao.java
----
private Datastore datastore;
private KeyFactory keyFactory;

public DatastoreDao() {
  datastore = DatastoreOptions.getDefaultInstance().getService(); // Authorized Datastore service
  keyFactory = datastore.newKeyFactory().setKind("Book2");      // Is used for creating keys later
}
----

=== Creating books

To save a book, the app stores an entity in Cloud Datastore. An entity has a key and a collection of name/value pairs. The `createBook` method starts with an `IncompleteKey`, which gets assigned a value when the entity is added to the data store.
The code builds the entity according to the https://en.wikipedia.org/wiki/Builder_pattern[Builder design pattern] by making repeated calls to the set method.

[source, java]
./bookshelf/2-structured-data/src/main/java/com/example/getstarted/daos/DatastoreDao.java
----
@Override
public Long createBook(Book book) {
  IncompleteKey key = keyFactory.newKey();          // Key will be assigned once written
  FullEntity<IncompleteKey> incBookEntity = Entity.newBuilder(key)  // Create the Entity
      .set(Book.AUTHOR, book.getAuthor())           // Add Property ("author", book.getAuthor())
      .set(Book.DESCRIPTION, book.getDescription())
      .set(Book.PUBLISHED_DATE, book.getPublishedDate())
      .set(Book.TITLE, book.getTitle())
      .build();
  Entity bookEntity = datastore.add(incBookEntity); // Save the Entity
  return bookEntity.getKey().getId();                     // The ID of the Key
}
----

=== Reading from Cloud Datastore

The `readBook` method takes a book's ID and converts it to a key. Then it passes the key to the get method, which returns an `Entity` object.

[source, java]
./bookshelf/2-structured-data/src/main/java/com/example/getstarted/daos/DatastoreDao.java
----
@Override
public Book readBook(Long bookId) {
  Entity bookEntity = datastore.get(keyFactory.newKey(bookId)); // Load an Entity for Key(id)
  return entityToBook(bookEntity);
}
----

The `entityToBook` method converts the entity returned from Cloud Datastore to a Book object using `get` methods for each type, like `set`, take a `String` as a property name.

[source, java]
./bookshelf/2-structured-data/src/main/java/com/example/getstarted/daos/DatastoreDao.java
----
public Book entityToBook(Entity entity) {
  return new Book.Builder()                                     // Convert to Book form
      .author(entity.getString(Book.AUTHOR))
      .description(entity.getString(Book.DESCRIPTION))
      .id(entity.getKey().getId())
      .publishedDate(entity.getString(Book.PUBLISHED_DATE))
      .title(entity.getString(Book.TITLE))
      .build();
}
----

=== Updating books

Update just requires calling the `update` method with an `Entity`.

[source, java]
./bookshelf/2-structured-data/src/main/java/com/example/getstarted/daos/DatastoreDao.java
----
@Override
public void updateBook(Book book) {
  Key key = keyFactory.newKey(book.getId());  // From a book, create a Key
  Entity entity = Entity.newBuilder(key)         // Convert Book to an Entity
      .set(Book.AUTHOR, book.getAuthor())
      .set(Book.DESCRIPTION, book.getDescription())
      .set(Book.PUBLISHED_DATE, book.getPublishedDate())
      .set(Book.TITLE, book.getTitle())
      .build();
  datastore.update(entity);                   // Update the Entity
}
----

Deleting with Datastore requires calling the `delete` method with a `Key`.

=== Deleting books

[source, java]
bookshelf/2-structured-data/src/main/java/com/example/getstarted/daos/DatastoreDao.java
----
@Override
public void deleteBook(Long bookId) {
  Key key = keyFactory.newKey(bookId);        // Create the Key
  datastore.delete(key);                      // Delete the Entity
}
----

=== Listing books
The `listBooks` method returns a list of books, ten at a time, along with a URL safe `Cursor:

[source, java]
./bookshelf/2-structured-data/src/main/java/com/example/getstarted/daos/DatastoreDao.java
----
@Override
public Result<Book> listBooks(String startCursorString) {
  Cursor startCursor = null;
  if (startCursorString != null && !startCursorString.equals("")) {
    startCursor = Cursor.fromUrlSafe(startCursorString);    // Where we left off
  }
  Query<Entity> query = Query.newEntityQueryBuilder()       // Build the Query
      .setKind("Book2")                                     // We only care about Books
      .setLimit(10)                                         // Only show 10 at a time
      .setStartCursor(startCursor)                          // Where we left off
      .setOrderBy(OrderBy.asc(Book.TITLE))                  // Use default Index "title"
      .build();
  QueryResults<Entity> resultList = datastore.run(query);   // Run the query
  List<Book> resultBooks = entitiesToBooks(resultList);     // Retrieve and convert Entities
  Cursor cursor = resultList.getCursorAfter();              // Where to start next time
  if (cursor != null && resultBooks.size() == 10) {         // Are we paging? Save Cursor
    String cursorString = cursor.toUrlSafe();               // Cursors are WebSafe
    return new Result<>(resultBooks, cursorString);
  } else {
    return new Result<>(resultBooks);
  }
}
----

=== Indexing

Datastore automatically creates an index for each of your properties by default,
although it is possible to https://cloud.google.com/datastore/docs/concepts/indexes#index_configuration[change this behavior].
Some queries need more than a single property in the index to complete, such as the Query by user, ordered by Title query above.
The https://cloud.google.com/datastore/docs/tools/datastore-emulator[Datastore emulator] will suggest indexes that your app will need.

Create these indexes now:

`gcloud datastore create-indexes index.yaml`

== Using Cloud Storage with Java

This part of the Bookshelf tutorial for Java shows how to store images in https://cloud.google.com/storage[Google Cloud Storage].

This page is part of a multi-page tutorial. To start from the beginning and see instructions for setting up, go to https://cloud.google.com/java/getting-started/tutorial-app[Java Bookshelf App].

=== Creating a Cloud Storage bucket

The following instructions show how to create a Cloud Storage bucket.

**Note: You can choose any name for your Cloud Storage bucket. It's a good practice to name your bucket the same as your project ID, which helps to keep the name easy to remember. Bucket names must be unique across all of Cloud Platform, so there is some chance that you won't be able to use your project ID as the bucket name.**

To create a bucket:

1. Invoke the following command in a terminal window:
`gsutil mb gs://[YOUR-BUCKET-NAME]` 

2. Set the bucket's default ACL to public-read, which enables users to see their uploaded images:
`gsutil defacl set public-read gs://[YOUR-BUCKET-NAME]`


=== Configuring settings
=== Running the app on your local machine

To run the app locally:

1. In the getting-started-java/bookshelf/bookshelf directory, enter this command to start a local web server:
`mvn -Plocal clean jetty:run-exploded -DprojectID=[YOUR-PROJECT-ID]`
2. In your web browser, navigate to http://localhost:8080[http://localhost:8080]

Now you can browse the app's web pages, add books with cover images, edit books, and delete books.

=== Deploying the app to the App Engine flexible environment

1. Enter this command to deploy the app:  
`mvn appengine:deploy -DprojectID=YOUR-PROJECT-ID`

2. In your web browser, enter this address. Replace [YOUR_PROJECT_ID] with your project ID:  
`https://[YOUR_PROJECT_ID].appspot-preview.com`

If you update your app, you can deploy the updated version by entering the same command you used to deploy the app the first time. The new deployment creates a new version of your app and promotes it to the default version. The older versions of your app remain, as do their associated VM instances. Be aware that all of these app versions and VM instances are billable resources.

You can reduce costs by deleting the non-default versions of your app.

To delete an app version:

1. In the Cloud Platform Console, go to the App Engine Versions page.  
https://console.cloud.google.com/appengine/versions?_ga=1.119646536.1963584502.1488379440[GO TO THE VERSIONS PAGE]
2. Click the checkbox next to the non-default app version you want to delete.  
**Note: The only way to delete the default version of your App Engine app is to delete your project. You can, however, stop the default version in the Cloud Platform Console. This will shut down all instances associated with the version. You can restart these instances later if needed.  
You can overwrite the default version of your app by redeploying the app.**  
3. Click the Delete button at the top of the page to delete the app version.
4. 
For complete information about cleaning up billable resources, see the Cleaning up section in the final step of this tutorial.

=== Application structure

image::java-binary-data.png[]

The application uses Cloud Storage to store binary data, pictures in this case. The app continues to use Cloud Datastore for book information.

=== Understanding the code

This section walks you through the application code and explains how it works.

=== Handling user uploads

It is simple to use the https://googlecloudplatform.github.io/google-cloud-java/apidocs/?com/google/cloud/storage/package-summary.html[Google Cloud Storage API for Java]. In most cases, a single line is all you need to authenticate locally.

[source, java]
./bookshelf/3-binary-data/src/main/java/com/example/getstarted/util/CloudStorageHelper.java
----
static {
  storage = StorageOptions.getDefaultInstance().getService();
}
----

=== Uploading blobs to Cloud Storage
Read the file from a POST request using https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpServletRequest.html#getPart-java.lang.String[getPart]. Verify the file matches your requirements before uploading it.

[source, java]
https://github.com/GoogleCloudPlatform/getting-started-java/blob/master/bookshelf/3-binary-data/src/main/java/com/example/getstarted/util/CloudStorageHelper.java
----
/**
 * Extracts the file payload from an HttpServletRequest, checks that the file extension
 * is supported and uploads the file to Google Cloud Storage.
 */
public String getImageUrl(HttpServletRequest req, HttpServletResponse resp,
                          final String bucket) throws IOException, ServletException {
  Part filePart = req.getPart("file");
  final String fileName = filePart.getSubmittedFileName();
  String imageUrl = req.getParameter("imageUrl");
  // Check extension of file
  if (fileName != null && !fileName.isEmpty() && fileName.contains(".")) {
    final String extension = fileName.substring(fileName.lastIndexOf('.') + 1);
    String[] allowedExt = { "jpg", "jpeg", "png", "gif" };
    for (String s : allowedExt) {
      if (extension.equals(s)) {
        return this.uploadFile(filePart, bucket);
      }
    }
    throw new ServletException("file must be an image");
  }
  return imageUrl;
}
----

Then, make the filename unique by appending a timestamp to it. Using `storage.create`, pass a `BlobInfo` created with `bucketName` and `fileName`, and set the access control list so that all users can read and pass the file's `InputStream. The result is the public URL for the object.

[source, java]
./bookshelf/3-binary-data/src/main/java/com/example/getstarted/util/CloudStorageHelper.java
----
**
 * Uploads a file to Google Cloud Storage to the bucket specified in the BUCKET_NAME
 * environment variable, appending a timestamp to end of the uploaded filename.
 */
public String uploadFile(Part filePart, final String bucketName) throws IOException {
  DateTimeFormatter dtf = DateTimeFormat.forPattern("-YYYY-MM-dd-HHmmssSSS");
  DateTime dt = DateTime.now(DateTimeZone.UTC);
  String dtString = dt.toString(dtf);
  final String fileName = filePart.getSubmittedFileName() + dtString;

  // the inputstream is closed by default, so we don't need to close it here
  BlobInfo blobInfo =
      storage.create(
          BlobInfo
              .newBuilder(bucketName, fileName)
              // Modify access list to allow all users with link to read file
              .setAcl(new ArrayList<>(Arrays.asList(Acl.of(User.ofAllUsers(), Role.READER))))
              .build(),
          filePart.getInputStream());
  // return the public download link
  return blobInfo.getMediaLink();
}
----

## Authenticating Users with Java

This part of the Bookshelf tutorial for Java shows how to create a sign-in flow for users and how to use profile information to provide users with personalized functionality.

By using https://developers.google.com/identity/[Google Identity Platform], you can easily access information about your users while ensuring their sign-in credentials are safely managed by Google. https://developers.google.com/identity/protocols/OpenIDConnect[OAuth 2.0] makes it easy to provide a sign-in flow for all users of your app and provides your application with access to basic profile information about authenticated users.

This page is part of a multi-page tutorial. To start from the beginning and see instructions for setting up, go to https://cloud.google.com/java/getting-started/tutorial-app[Java Bookshelf App].

=== Creating a web application client ID

A web application client ID allows your application to authorize users and access Google APIs on behalf of your users.

1. Go to the https://console.cloud.google.com/apis/credentials?_ga=1.16303478.1963584502.1488379440[credentials section in the Google Cloud Platform Console].
2. Click **OAuth consent screen**. For the the product name, enter `Java Bookshelf App`. Fill in any relevant optional fields. Click **Save**.
3. Click **Create credentials > OAuth client ID**.
4. Under **Application type**, select **Web Application**.
5. Under **Name**, enter `Java Bookshelf Client`.
6. Under **Authorized redirect URIs** enter the following URLs, one at a time. Replace `[YOUR_PROJECT_ID]` with your project ID:
`http://localhost:8080/oauth2callback`    
`http://[YOUR_PROJECT_ID].appspot.com/oauth2callback`  
`https://[YOUR_PROJECT_ID].appspot.com/oauth2callback`  
`http://[YOUR_PROJECT_ID].appspot-preview.com/oauth2callback`  
https://[YOUR_PROJECT_ID].appspot-preview.com/oauth2callback`  
7. Click **Create**.
8. Copy the **client ID** and **client secret** and save them for later use.

=== Configuring settings

In the `getting-started-java/bookshelf/bookshelf` directory, open `pom.xml` for editing.
1. In the `<properties>` section, set `callback.host` to `[YOUR_PROJECT_ID].appspot.com`.
2. Set `bookshelf.clientID` to the client ID you created previously.
3. Set `bookshelf.clientSecret` to the client secret you created previously.
4. Save and close `pom.xml`.

=== Running the app on your local machine

To run the app locally:

1. In the `getting-started-java/bookshelf/bookshelf` directory, enter this command to start a local web server:
`mvn -Plocal clean jetty:run-exploded -DprojectID=[YOUR-PROJECT-ID]`
2. In your web browser, navigate to `http://localhost:8080`

Now you can browse the app's web pages, sign in using your Google account, add books, and see the books you've added using the **My Books** link in the top navigation bar.

=== Deploying the app to the App Engine flexible environment

1. Enter this command to deploy the app:  
`mvn appengine:deploy -DprojectID=YOUR-PROJECT-ID`
2. In your web browser, enter this address. Replace `[YOUR_PROJECT_ID]` with your project ID:  
`https://[YOUR_PROJECT_ID].appspot-preview.com`

If you update your app, you can deploy the updated version by entering the same command you used to deploy the app the first time. The new deployment creates a new version of your app and promotes it to the default version. The older versions of your app remain, as do their associated VM instances. Be aware that all of these app versions and VM instances are billable resources.

You can reduce costs by deleting the non-default versions of your app.

To delete an app version:

1. In the Cloud Platform Console, go to the App Engine Versions page.  
https://console.cloud.google.com/appengine/versions?_ga=1.78701012.1963584502.1488379440[GO TO THE VERSIONS PAGE]
2. Click the checkbox next to the non-default app version you want to delete.  

NOTE: The only way to delete the default version of your App Engine app is to delete your project. You can, however, stop the default version in the Cloud Platform Console. This will shut down all instances associated with the version. You can restart these instances later if needed. You can overwrite the default version of your app by redeploying the app.
3. Click the Delete button at the top of the page to delete the app version.

For complete information about cleaning up billable resources, see the Cleaning up section in the final step of this tutorial.

=== Application structure

The following diagram shows the application's components and how they connect to one another.

image::java-auth.png[]

=== Understanding the code

This section walks you through the application code and explains how it works.

The `LoginServlet` is invoked when the user clicks **Login**. It does the following:

1. Save some random `state to help https://developers.google.com/identity/protocols/OpenIDConnect#authenticationuriparameters[prevent request forgeries].
2. Save the destination of where to go after sign in.
3. Use the https://developers.google.com/api-client-library/java/google-api-java-client/reference/1.19.1/?overview-summary.html[Google API Client Library],
specifically https://developers.google.com/api-client-library/java/google-api-java-client/reference/1.19.1/com/google/api/client/googleapis/auth/oauth2/GoogleAuthorizationCodeFlow.html[GoogleAuthorizationCodeFlow],
to generate a callback request to Google to handle signing in to a Google account. This app specifies the "email" and "profile" scopes, so it can display the user's email and image on each page:

[source, java]
./bookshelf/4-auth/src/main/java/com/example/getstarted/auth/LoginServlet.java
----
@WebServlet(name = "login", value = "/login")
@SuppressWarnings("serial")
public class LoginServlet extends HttpServlet {

  private static final Collection<String> SCOPES = Arrays.asList("email", "profile");
  private static final JsonFactory JSON_FACTORY = new JacksonFactory();
  private static final HttpTransport HTTP_TRANSPORT = new NetHttpTransport();

  private GoogleAuthorizationCodeFlow flow;

  @Override
  protected void doGet(HttpServletRequest req, HttpServletResponse resp)
      throws IOException, ServletException {

    String state = new BigInteger(130, new SecureRandom()).toString(32);  // prevent request forgery
    req.getSession().setAttribute("state", state);

    if (req.getAttribute("loginDestination") != null) {
      req
          .getSession()
          .setAttribute("loginDestination", (String) req.getAttribute("loginDestination"));
    } else {
      req.getSession().setAttribute("loginDestination", "/books");
    }

    flow = new GoogleAuthorizationCodeFlow.Builder(
        HTTP_TRANSPORT,
        JSON_FACTORY,
        getServletContext().getInitParameter("bookshelf.clientID"),
        getServletContext().getInitParameter("bookshelf.clientSecret"),
        SCOPES)
        .build();

    // Callback url should be the one registered in Google Developers Console
    String url =
        flow.newAuthorizationUrl()
            .setRedirectUri(getServletContext().getInitParameter("bookshelf.callback"))
            .setState(state)            // Prevent request forgery
            .build();
    resp.sendRedirect(url);
  }
}
----

Google redirects the user to the `/oauth2callback` URL. After the user successfully signs in, the `Oauth2CallbackServlet` `doGet` method does the following:

1. Check that its not a forgery by comparing our `state` with the saved session `state`.
2. Delete the saved session `state`.
3. Get the response `tokenResponse`.
4. Use the `tokenResponse` to get a `Credential`.
5. Use the `credential` to create a `requestFactory`.
6. Use the `request` to get the `jsonIdentity`.
7. Extract email, a picture, and an ID.
8. Redirect to the saved `loginDestination` from the prior step.

[source, java]
./bookshelf/4-auth/src/main/java/com/example/getstarted/auth/Oauth2CallbackServlet.java
----
@WebServlet(name = "oauth2callback", value = "/oauth2callback")
@SuppressWarnings("serial")
public class Oauth2CallbackServlet extends HttpServlet {

  private static final Collection<String> SCOPES = Arrays.asList("email", "profile");
  private static final String USERINFO_ENDPOINT
      = "https://www.googleapis.com/plus/v1/people/me/openIdConnect";
  private static final JsonFactory JSON_FACTORY = new JacksonFactory();
  private static final HttpTransport HTTP_TRANSPORT = new NetHttpTransport();

  private GoogleAuthorizationCodeFlow flow;

  @Override
  public void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException,
      ServletException {

    // Ensure that this is no request forgery going on, and that the user
    // sending us this connect request is the user that was supposed to.
    if (req.getSession().getAttribute("state") == null
        || !req.getParameter("state").equals((String) req.getSession().getAttribute("state"))) {
      resp.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
      resp.sendRedirect("/books");
      return;
    }

    req.getSession().removeAttribute("state");     // Remove one-time use state.

    flow = new GoogleAuthorizationCodeFlow.Builder(
        HTTP_TRANSPORT,
        JSON_FACTORY,
        getServletContext().getInitParameter("bookshelf.clientID"),
        getServletContext().getInitParameter("bookshelf.clientSecret"),
        SCOPES).build();

    final TokenResponse tokenResponse =
        flow.newTokenRequest(req.getParameter("code"))
            .setRedirectUri(getServletContext().getInitParameter("bookshelf.callback"))
            .execute();

    req.getSession().setAttribute("token", tokenResponse.toString()); // Keep track of the token.
    final Credential credential = flow.createAndStoreCredential(tokenResponse, null);
    final HttpRequestFactory requestFactory = HTTP_TRANSPORT.createRequestFactory(credential);

    final GenericUrl url = new GenericUrl(USERINFO_ENDPOINT);      // Make an authenticated request.
    final HttpRequest request = requestFactory.buildGetRequest(url);
    request.getHeaders().setContentType("application/json");

    final String jsonIdentity = request.execute().parseAsString();
    @SuppressWarnings("unchecked")
    HashMap<String, String> userIdResult =
        new ObjectMapper().readValue(jsonIdentity, HashMap.class);
    // From this map, extract the relevant profile info and store it in the session.
    req.getSession().setAttribute("userEmail", userIdResult.get("email"));
    req.getSession().setAttribute("userId", userIdResult.get("sub"));
    req.getSession().setAttribute("userImageUrl", userIdResult.get("picture"));
    resp.sendRedirect((String) req.getSession().getAttribute("loginDestination"));
  }
}
----

The `LogoutServlet` deletes the `session` and creates a new one:

[source, java]
----
@WebServlet(name = "logout", value = "/logout")
@SuppressWarnings("serial")
public class LogoutServlet extends HttpServlet {

  @Override
  protected void doGet(HttpServletRequest req, HttpServletResponse resp)
      throws IOException, ServletException {
    // you can also make an authenticated request to logout, but here we choose to
    // simply delete the session variables for simplicity
    HttpSession session =  req.getSession(false);
    if (session != null) {
      session.invalidate();
    }
    // rebuild session
    req.getSession();
  }
}
----

== Logging Application Events with Java

This part of the Bookshelf tutorial for Java shows how an app can incorporate detailed logging to help with detecting, debugging, and monitoring potential issues.

This page is part of a multi-page tutorial. To start from the beginning and see instructions for setting up, go to https://cloud.google.com/java/getting-started/tutorial-app[Java Bookshelf App].

=== Running the app on your local machine

To run the app locally:

1. In the `getting-started-java/bookshelf/bookshelf` directory, enter this command to start a local web server:  
`mvn -Plocal clean jetty:run-exploded -DprojectID=[YOUR-PROJECT-ID]`
2, In your web browser, navigate to http://localhost:8080[http://localhost:8080]

=== Deploying the app to the App Engine flexible environment

1. Enter this command to deploy the app:  
`mvn appengine:deploy -DprojectID=YOUR-PROJECT-ID`
2. In your web browser, enter this address. Replace `[YOUR_PROJECT_ID]` with your project ID:  
`https://[YOUR_PROJECT_ID].appspot-preview.com`

If you update your app, you can deploy the updated version by entering the same command you used to deploy the app the first time. The new deployment creates a new version of your app and promotes it to the default version. The older versions of your app remain, as do their associated VM instances. Be aware that all of these app versions and VM instances are billable resources.

You can reduce costs by deleting the non-default versions of your app.

To delete an app version:

1. In the Cloud Platform Console, go to the App Engine Versions page.  
https://console.cloud.google.com/appengine/versions?_ga=1.80399703.1963584502.1488379440[GO TO THE VERSIONS PAGE]
2. Click the checkbox next to the non-default app version you want to delete.  
**Note: The only way to delete the default version of your App Engine app is to delete your project. You can, however, stop the default version in the Cloud Platform Console. This will shut down all instances associated with the version. You can restart these instances later if needed.  
You can overwrite the default version of your app by redeploying the app.**
3. Click the **Delete** button at the top of the page to delete the app version.

For complete information about cleaning up billable resources, see the Cleaning up section in the final step of this tutorial.

=== Viewing logs

As the bookshelf app runs, it writes logging data that is collected and made available in the Cloud Platform Console. You can use the https://console.cloud.google.com/logs?_ga=1.80399703.1963584502.1488379440[log monitoring tools] in the Cloud Platform Console to analyze the logs directly. If you want more detailed analysis, you can use the Cloud Platform Console to stream or import the app's logs into https://cloud.google.com/logging/docs/install/logs_export[BigQuery] or export them to a https://cloud.google.com/logging/docs/install/logs_export[Cloud Storage Bucket].

image::dev-console-log-monitor.png[]

=== Application structure

The following diagram shows how the app handles logging when deployed to the App Engine flexible environment.

image::java-logs-gae.png[]

The following diagram shows how the app handles logging when deployed to Google Compute Engine, which is covered in the https://cloud.google.com/java/getting-started/run-on-compute-engine[last step] of the tutorial.

image::java-logs-gce.png[]

=== Understanding the code
There are many Java logging packages that are compatible with the App Engine flexible environment. This sample uses https://docs.oracle.com/javase/8/docs/api/java/util/logging/package-summary.html[java.util.logging], as it's the most well understood. Each class needs a `Logger` instantiated as follows:

[source, java]
./bookshelf/5-logging/src/main/java/com/example/getstarted/basicactions/ReadBookServlet.java
----
private final Logger logger = Logger.getLogger(ReadBookServlet.class.getName());
----

The `log` method, takes a https://docs.oracle.com/javase/8/docs/api/java/util/logging/Level.html[Level] and a string.
Possible values for the level are of `FINEST`, `FINER`, `FINE`, `CONFIG`, `INFO`, `WARNING`, and `SERVERE`. It is also possible to log using one of the short-cut methods: `config`, `info`, `warning`, or `severe`.

[source, java]
./bookshelf/5-logging/src/main/java/com/example/getstarted/basicactions/ReadBookServlet.java
----
logger.log(Level.INFO, "Read book with id {0}", id);
----

Logging levels, which are often set from properties files, can also be set and changed in `app.yaml:

[source, yaml]
./bookshelf/5-logging/src/main/appengine/app.yaml
----
env_variables:    # Logging options
  JAVA_OPTS: >-
    -D.level=INFO
----
    
=== Understanding the logging configuration

When the sample app runs in the App Engine flexible environment, anything logged to `stderr` and `stdout` is automatically collected by Cloud Logging and available for viewing, searching, and exporting in the https://console.cloud.google.com/logs?_ga=1.79946327.1963584502.1488379440[logs viewer in the Cloud Platform Console].

In this sample, all logs are written to `stderr`/`stdout`.

=== Cleaning up

To avoid incurring charges to your Google Cloud Platform account for the resources used in this tutorial:

=== Delete the project

The easiest way to eliminate billing is to delete the project you created for the tutorial.

To delete the project:

**Warning: Deleting a project has the following consequences:
If you used an existing project, you'll also delete any other work you've done in the project.
You can't reuse the project ID of a deleted project. If you created a custom project ID that you plan to use in the future, you should delete the resources inside the project instead. This ensures that URLs that use the project ID, such as an appspot.com URL, remain available.
If you are exploring multiple tutorials and quickstarts, reusing projects instead of deleting them prevents you from exceeding project quota limits.**

1. In the Cloud Platform Console, go to the Projects page.  
https://console.cloud.google.com/iam-admin/projects?_ga=1.77720276.1963584502.1488379440[GO TO THE PROJECTS PAGE]
2. In the project list, select the project you want to delete and click **Delete project**.  
image::delete-project-screenshot.png[]
3. In the dialog, type the project ID, and then click Shut down to delete the project.

=== Delete non-default versions of your app

If you don't want to delete your project, you can reduce costs by deleting the non-default versions of your app.

To delete an app version:

1. In the Cloud Platform Console, go to the App Engine Versions page.  
https://console.cloud.google.com/appengine/versions?_ga=1.121892171.1963584502.1488379440[GO TO THE VERSIONS PAGE]
2. Click the checkbox next to the non-default app version you want to delete.
**Note: The only way to delete the default version of your App Engine app is to delete your project. You can, however, stop the default version in the Cloud Platform Console. This will shut down all instances associated with the version. You can restart these instances later if needed.
You can overwrite the default version of your app by redeploying the app.**
3. Click the Delete button at the top of the page to delete the app version.

=== Delete your Cloud Storage bucket

To delete a Cloud Storage bucket:

1. In the Cloud Platform Console, go to the Cloud Storage browser.  
https://console.cloud.google.com/storage/browser?_ga=1.11738740.1963584502.1488379440[GO TO THE CLOUD STORAGE BROWSER]
2. Click the checkbox next to the bucket you want to delete.
3. Click the **Delete** button at the top of the page to delete the bucket.
    

































