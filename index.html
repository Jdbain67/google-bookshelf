<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.3">
<meta name="copyright" content="Apache License, Version 2.0">
<title>Google Cloud Bookshelf with Grails</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Google Cloud Bookshelf with Grails</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_overview">1. Overview</a>
<ul class="sectlevel2">
<li><a href="#_objectives">1.1. Objectives</a></li>
<li><a href="#_costs">1.2. Costs</a></li>
<li><a href="#_before_you_begin">1.3. Before you begin</a></li>
<li><a href="#_tutorial_structure">1.4. Tutorial structure</a></li>
<li><a href="#_running_the_app_on_your_local_machine">1.5. Running the app on your local machine</a></li>
<li><a href="#_deploying_the_app_to_the_app_engine_flexible_environment">1.6. Deploying the app to the App Engine flexible environment</a></li>
</ul>
</li>
<li><a href="#_controllers_and_views">2. Controllers and Views</a>
<ul class="sectlevel2">
<li><a href="#_internationalization">2.1. Internationalization</a></li>
<li><a href="#_listing_books">2.2. Listing books</a></li>
<li><a href="#_create_a_book">2.3. Create a book</a></li>
<li><a href="#_display_book">2.4. Display book</a></li>
<li><a href="#_delete_book">2.5. Delete book</a></li>
<li><a href="#_edit_a_book">2.6. Edit a book</a></li>
<li><a href="#_update_a_book">2.7. Update a book</a></li>
</ul>
</li>
<li><a href="#_services">3. Services</a>
<ul class="sectlevel2">
<li><a href="#_configuration">3.1. Configuration</a></li>
<li><a href="#_service_integration_overview">3.2. Service integration Overview</a></li>
<li><a href="#_handling_cover_image_upload">3.3. Handling Cover Image upload</a></li>
<li><a href="#_uploading_an_image_to_cloud_storage">3.4. Uploading an image to Cloud Storage</a></li>
<li><a href="#_extracting_the_text_of_an_image_with_cloud_vision">3.5. Extracting the text of an image with Cloud Vision</a></li>
<li><a href="#_translate_text_with_cloud_translation_api">3.6. Translate Text with Cloud Translation API</a></li>
<li><a href="#_interact_with_cloud_sql_mysql_database_with_gorm_hibernate_implementation">3.7. Interact with Cloud SQL: MySQL database with GORM Hibernate implementation</a></li>
</ul>
</li>
<li><a href="#_authenticating_users_with_grails">4. Authenticating Users with Grails</a>
<ul class="sectlevel2">
<li><a href="#_creating_a_web_application_client_id">4.1. Creating a web application client ID</a></li>
<li><a href="#_configuring_settings">4.2. Configuring settings</a></li>
<li><a href="#_application_structure">4.3. Application structure</a></li>
<li><a href="#_understanding_the_code">4.4. Understanding the code</a></li>
</ul>
</li>
<li><a href="#_logging_application_events_with_grails">5. Logging Application Events with Grails</a>
<ul class="sectlevel2">
<li><a href="#_viewing_logs">5.1. Viewing logs</a></li>
<li><a href="#_application_structure_2">5.2. Application structure</a></li>
<li><a href="#_understanding_the_code_2">5.3. Understanding the code</a></li>
<li><a href="#_understanding_the_logging_configuration">5.4. Understanding the logging configuration</a></li>
</ul>
</li>
<li><a href="#_cleaning_up">6. Cleaning up</a>
<ul class="sectlevel2">
<li><a href="#_delete_the_project">6.1. Delete the project</a></li>
<li><a href="#_delete_non_default_versions_of_your_app">6.2. Delete non-default versions of your app</a></li>
<li><a href="#_delete_your_cloud_storage_bucket">6.3. Delete your Cloud Storage bucket</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_overview">1. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Bookshelf app is a sample web app written in <a href="http://groovy-lang.org">Groovy</a> with the <a href="http://grails.org">Grails framework</a>.
It shows how to use a variety of Google Cloud Platform products, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Google <a href="https://cloud.google.com/appengine/docs/flexible/">App Engine Flexible Environment</a></p>
</li>
<li>
<p>Google <a href="https://cloud.google.com/sql/">Cloud SQL</a></p>
</li>
<li>
<p>Google <a href="https://cloud.google.com/storage/">Cloud Storage</a></p>
</li>
<li>
<p>Google <a href="https://cloud.google.com/vision/">Cloud Vision API</a></p>
</li>
<li>
<p>Google <a href="https://cloud.google.com/translate/">Cloud Translation API</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This tutorial explores the Bookshelf app in detail, and discusses how each feature of the app is implemented using familiar technologies and services provided by Cloud Platform.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/bookshelf-app-3.png" alt="bookshelf app 3">
</div>
</div>
<div class="paragraph">
<p>The Bookshelf sample app stores a collection of book titles. Anyone who has access to the app can add books to the list. The sample app offers these features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Users can view the list of books</p>
</li>
<li>
<p>Users can remove books from the list.</p>
</li>
<li>
<p>Users can add books. They create books uploading a cover image, text int that image is detected and used to populate the book title.</p>
</li>
<li>
<p>Users can edit book metadata such as title, description, author or publication date.</p>
</li>
<li>
<p>A title and description for Spanish and Italian is generated on the fly.</p>
</li>
<li>
<p>Users can log in with their Google accounts and view the books that they have added to the list.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_objectives">1.1. Objectives</h3>
<div class="ulist">
<ul>
<li>
<p>Clone or download the sample app.</p>
</li>
<li>
<p>Build the app and run it on your local machine.</p>
</li>
<li>
<p>Deploy the app to App Engine.</p>
</li>
<li>
<p>Walk through the sample code.</p>
</li>
<li>
<p>Learn how the app stores structured data.</p>
</li>
<li>
<p>Learn how the app stores binary data in Google Cloud Storage.</p>
</li>
<li>
<p>Learn how the app uses Cloud Translate API to translate English text into Spanish and Italian</p>
</li>
<li>
<p>Learn how the app uses Cloud Vision to extract text from a cover image</p>
</li>
<li>
<p>Learn how the app authenticates users.</p>
</li>
<li>
<p>Learn how the app creates event logs that are visible in the Google Cloud Platform Console.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_costs">1.2. Costs</h3>
<div class="paragraph">
<p>This tutorial uses billable components of Cloud Platform including Google Compute Engine.</p>
</div>
<div class="paragraph">
<p>This tutorial has several steps, and each step is documented on its own page. The final page of the tutorial includes
instructions for cleaning up resources, so you won&#8217;t continue to be billed for Cloud Platform services.
If you decide not to complete all the steps of the tutorial, see the <a href="index.html#_cleaning_up">cleanup instructions</a> on the final page.</p>
</div>
</div>
<div class="sect2">
<h3 id="_before_you_begin">1.3. Before you begin</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the Cloud Platform Console to set up your Google Cloud Platform project:</p>
<div class="ulist">
<ul>
<li>
<p>Create a new Cloud Platform project, and then create an App Engine application and enable billing in that project:
<a href="https://console.cloud.google.com/projectselector/appengine/create?lang=flex_java&amp;st=true&amp;_ga=1.20629880.1963584502.1488379440">GO TO APP ENGINE</a></p>
</li>
<li>
<p>Enable the Cloud Datastore, Cloud Pub/Sub, Cloud Storage JSON, Stackdriver Logging, and Google+ APIs.
<a href="https://console.cloud.google.com/flows/enableapi?apiid=datastore.googleapis.com,datastore,pubsub,storage_api,translate,vision.googleapis.com,logging,plus,sqladmin.googleapis.com&amp;redirect=https://console.cloud.google.com&amp;_ga=1.20629880.1963584502.1488379440">ENABLE THE APIS</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>To deploy a Java app to App Engine, you must first setup your environment, see <a href="https://cloud.google.com/appengine/docs/standard/java/tools/gradle">Using Gradle and the App Engine Plugin</a> for details.</p>
</li>
<li>
<p>Download, install, and initialize the Google Cloud SDK:
<a href="https://cloud.google.com/sdk/docs/">DOWNLOAD THE SDK</a></p>
</li>
<li>
<p>Acquire local credentials for authenticating with Google Cloud Platform services:
<code>gcloud beta auth application-default login</code></p>
</li>
<li>
<p>Verify that your default project is correct:<br>
<code>gcloud config list</code><br>
If the project ID listed in the output is not the project that you intended to use for this tutorial, set the project by entering this command:<br>
<code>gcloud config set project [YOUR_PROJECT_ID]</code><br>
where [YOUR_PROJECT_ID] is the ID of the project you created or chose to use for this tutorial.</p>
</li>
<li>
<p>Clone the sample repository:<br>
<code>git clone <a href="https://github.com/grails-samples/google-bookshelf.git" class="bare">https://github.com/grails-samples/google-bookshelf.git</a></code></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can create Google Cloud SDK configurations to set configuration properties like a Cloud Platform project ID, and then quickly switch between those configurations each time you use the gcloud tool,
see Managing Cloud SDK Configurations for more information.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, you can <a href="https://github.com/grails-samples/google-bookshelf/archive/master.zip">download the sample</a> as a zip file and extract it.</p>
</div>
<div class="paragraph">
<p>This tutorial assumes that you are familiar with Groovy and Grails and that you have <a href="http://www.oracle.com/technetwork/java/javase/downloads/">Java 8</a> and <a href="http://gradle.org/">Gradle</a> installed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tutorial_structure">1.4. Tutorial structure</h3>
<div class="paragraph">
<p>The Bookshelf tutorial has several parts that demonstrate how the sample app uses various Cloud Platform services and leverages Grails Features.</p>
</div>
<div class="paragraph">
<p>The Controllers and Views part demonstrates how the app uses Grails: Controllers, Command Objects and GSPs to generate the UI and handle interaction.</p>
</div>
<div class="paragraph">
<p>The Services part shows how Grails can interact with different Cloud Services.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This sample stores book information in a SQL database. The app&#8217;s web page
displays a form where the user can enter the title, author, description, and publication date of a book. For each book entered, the app stores this
information in a database, so it can be retrieved later for viewing or editing.</p>
</li>
<li>
<p>This sample app stores binary data in Cloud Storage. On the app&#8217;s web page, the user can specify a cover image for each book. The app stores the cover images in a Cloud Storage bucket.</p>
</li>
<li>
<p>This sample app uses Cloud Vision API to extract the text present on a book cover image.</p>
</li>
<li>
<p>This sample app uses Cloud Translation API to translate text from English into Spanish and Italian.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The authorization part of the tutorial demonstrates how the app provides a sign-in flow for the user. When a user is signed in,
any books entered are associated with the individual user. Signed-in users see only their own books.</p>
</div>
<div class="paragraph">
<p>The logging part of the tutorial demonstrates how the app writes logs that become visible in the Google Cloud Platform Console. Logs of this type can provide diagnostic information during app development.</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_app_on_your_local_machine">1.5. Running the app on your local machine</h3>
<div class="paragraph">
<p>To run the app locally while you are developing:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a MySQL database and configure its url, username and password in <code>app/grails-app/conf/application.yml</code></p>
</li>
<li>
<p>In the root of the repository, enter this command to start a local web server:<br>
<code>./gradlew app:bootRun</code></p>
</li>
<li>
<p>In your web browser, navigate to <a href="http://localhost:8080">http://localhost:8080</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_deploying_the_app_to_the_app_engine_flexible_environment">1.6. Deploying the app to the App Engine flexible environment</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a configuration file for production: <code>app/grails-app/conf/application-production.yml</code> See code listing below.</p>
</li>
<li>
<p>Enter this command to deploy the app:<br>
<code>./gradlew app:appengineDeploy</code></p>
</li>
<li>
<p>In your web browser, enter this address. Replace <code>[YOUR_PROJECT_ID]</code> with your project ID:<br>
<code>https://[YOUR_PROJECT_ID].appspot-preview.com</code><br></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">app/grails-app/conf/application-production.yml</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-yaml" data-lang="yaml">bookshelf:
    clientID: {CLIENTID}
    clientSecret: {CLIENTSECRET}
    callback: https://{PROJECT_ID}.appspot.com/oauth2callback
---
dataSource:
    dialect: org.hibernate.dialect.MySQL5InnoDBDialect
    driverClassName: com.mysql.jdbc.Driver
    dbCreate: update
    url: jdbc:mysql://google/{DATABASENAME}?cloudSqlInstance={CLOUD_SQL_INSTANCENAME}&amp;socketFactory=com.google.cloud.sql.mysql.SocketFactory&amp;user={USERNAME}&amp;password={PASSWORD}&amp;useSSL=false
    properties:
        jmxEnabled: true
        initialSize: 5
        maxActive: 50
        minIdle: 5
        maxIdle: 25
        maxWait: 10000
        maxAge: 600000
        timeBetweenEvictionRunsMillis: 5000
        minEvictableIdleTimeMillis: 60000
        validationQuery: SELECT 1
        validationQueryTimeout: 3
        validationInterval: 15000
        testOnBorrow: true
        testWhileIdle: true
        testOnReturn: false
        jdbcInterceptors: ConnectionState
        defaultTransactionIsolation: 2 # TRANSACTION_READ_COMMITTED</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
replace the above placeholders with the values of your configuration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you update your app, you can deploy the updated version by entering the same command you used to deploy the app the first time.
The new deployment creates a new version of your app and promotes it to the default version. The older versions of your app remain,
as do their associated VM instances. Be aware that all of these app versions and VM instances are billable resources.<br></p>
</div>
<div class="paragraph">
<p>You can reduce costs by deleting the non-default versions of your app.</p>
</div>
<div class="paragraph">
<p>To delete an app version:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Cloud Platform Console, go to the App Engine Versions page.
<a href="https://console.cloud.google.com/appengine/versions?_ga=1.17491577.1963584502.1488379440">GO TO THE VERSIONS PAGE</a></p>
</li>
<li>
<p>Click the checkbox next to the non-default app version you want to delete.</p>
</li>
<li>
<p>Click the <strong>Delete</strong> button at the top of the page to delete the app version.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note: The only way to delete the default version of your App Engine app is to delete your project. You can, however, stop the default version in the Cloud Platform Console. This will shut down all instances associated with the version. You can restart these instances later if needed.
You can overwrite the default version of your app by redeploying the app.</p>
</div>
<div class="paragraph">
<p>For complete information about cleaning up billable resources, see the Cleaning up section in the final step of this tutorial.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_controllers_and_views">2. Controllers and Views</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_internationalization">2.1. Internationalization</h3>
<div class="paragraph">
<p><a href="http://docs.grails.org/latest/guide/single.html#i18n">Grails supports Internationalization (i18n) out of the box</a>.</p>
</div>
<div class="paragraph">
<p>Books' titles and descriptions, coming from the persistence layer, are translated by Google Cloud Translation API.</p>
</div>
<div class="paragraph">
<p>To translate UI elements we use properties files:</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/i18n/messages.properties</div>
<div class="content">
<pre class="prettyprint highlight"><code>books=Books
books.mine=My books
login=Login
bookshelf=Bookshelf
book=Book
book.title=Title
book.author=Author
book.description=Description
book.cover.image=Cover Image
book.cover.image.url=Cover Image URL
book.date.published=Date Published
book.list.more=More
book.list.notFound=No books found
book.add=Add book
book.create=Create book
book.save=Save
book.edit=Edit book
book.delete=Delete book
book.author.by=By {0}
book.author.unknown=By Unknown
book.added.by=Added by {0}
book.added.by.anonymous=Added by Anonymous</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Spanish</strong></p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/i18n/messages_es.properties</div>
<div class="content">
<pre class="prettyprint highlight"><code>books=Libros
books.mine=Mis Libros
login=Entrar
bookshelf=Biblioteca
book=Libro
book.title=Título
book.author=Autor
book.description=Descripción
book.cover.image=Portada
book.cover.image.url=URL Portada
book.date.published=Fecha Publicación
book.list.more=Más
book.list.notFound=Libros no encontrados
book.add=Añadir libro
book.create=Crear libro
book.save=Guardar
book.edit=Editar libro
book.delete=Borrar libro
book.author.by=por {0}
book.author.unknown=por desconocido
book.added.by=Añadido por {0}
book.added.by.anonymous=Añadido porAnónimo</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Italian</strong></p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/i18n/messages_it.properties</div>
<div class="content">
<pre class="prettyprint highlight"><code>books=Libri
books.mine=I miei libri
login=Accesso
bookshelf=Libretto
book=Libro
book.title=Titolo
book.author=Autore
book.description=Descrizione
book.cover.image=Immagine di copertina
book.cover.image.url=Immagine di copertina URL
book.date.published=Data Pubblicata
book.list.more=Di Più
book.list.notFound=Nessun libro trovato
book.add=Aggiungi Libro
book.create=Aggiungi Libro
book.save=Salvare
book.edit=Modifica il libro
book.delete=Elimina il libro
book.author.by=By {0}
book.author.unknown=Per sconosciuto
book.added.by=Aggiunto da {0}
book.added.by.anonymous=Aggiunto da Anonimo</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_listing_books">2.2. Listing books</h3>
<div class="paragraph">
<p>We map the home page to be handled by the <code>BookController</code> <code>index</code> action.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/UrlMappings.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">'/'(controller: 'book', action: 'index', method: 'GET')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The controller&#8217;s action returns a list of books, along with a URL safe cursor.
It uses a service to fetch books and handles the model to the view:</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/BookController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def index(String cursor) {
    Result&lt;Book&gt; result = daoService.listBooks(cursor)
    log.info 'Retrieved list of all books'
    String title = messageSource.getMessage('books', null, 'Books', request.locale)
    [books: result.result, cursor: result.cursor, title: title]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see in the next code snippet, we use the <a href="http://docs.grails.org/latest/ref/Tags/message.html">message tag</a>
to reference the codes defined in the internationalization section.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/views/book/index.gsp</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">&lt;%@ page import="org.springframework.web.servlet.support.RequestContextUtils" %&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta name="layout" content="main" /&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class="container"&gt;
    &lt;h3&gt;${title}&lt;/h3&gt;
    &lt;a href="/create"&gt;
        &lt;i class="glyphicon glyphicon-plus"&gt;&lt;/i&gt;
        &lt;g:message code="book.add" default="Add book"/&gt;
    &lt;/a&gt;
    &lt;g:if test="${books}"&gt;
        &lt;g:each in="${books}" var="book"&gt;
            &lt;div class="media"&gt;
                &lt;g:link controller="book" action="show" id="${book.id}"&gt;
                    &lt;div class="media-left"&gt;
                        &lt;img alt="ahhh" src="${book?.imageUrl ?: 'http://placekitten.com/g/128/192'}"&gt;
                    &lt;/div&gt;
                    &lt;div class="media-body"&gt;
                        &lt;h4&gt;&lt;bookshelf:bookTitle id="${book?.id}" languageCode="${RequestContextUtils.getLocale(request).language}"/&gt;&lt;/h4&gt;
                        &lt;p&gt;${book.author}&lt;/p&gt;
                    &lt;/div&gt;
                &lt;/g:link&gt;
            &lt;/div&gt;
        &lt;/g:each&gt;
        &lt;g:if test="${cursor}"&gt;
            &lt;nav&gt;
                &lt;ul class="pager"&gt;
                    &lt;li&gt;&lt;a href="?cursor=${cursor}"&gt;&lt;g:message code="book.list.more" default="More"/&gt;&lt;/a&gt;&lt;/li&gt;
                &lt;/ul&gt;
            &lt;/nav&gt;
        &lt;/g:if&gt;
    &lt;/g:if&gt;
    &lt;g:else&gt;
        &lt;p&gt;&lt;g:message code="book.list.notFound" default="No books found"/&gt;&lt;/p&gt;
    &lt;/g:else&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_book">2.3. Create a book</h3>
<div class="paragraph">
<p>To create a book, we create a form which allows us to upload a cover image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/create-book.png" alt="create book">
</div>
</div>
<div class="paragraph">
<p>We map the display of the form to be handled by the <code>BookController</code> <code>create</code> action.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/UrlMappings.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">'/create'(controller: 'book', action: 'create', method: 'GET')</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/BookController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@SuppressWarnings('EmptyMethod')
def create() {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We render the form with the help of the <a href="https://docs.grails.org/latest/ref/Tags/form.html">Grails Form Tag</a>.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/views/book/create.gsp</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta name="layout" content="main" /&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class="container"&gt;
    &lt;h3&gt;&lt;g:message code="book.create" default="Create book"/&gt;&lt;/h3&gt;
    &lt;g:form method="POST" url="/create${book?.id ? ('/' + book.id) : ''}" enctype="multipart/form-data"&gt;
        &lt;div class="form-group ${application.isCloudStorageConfigured ? '' : 'hidden'}"&gt;
            &lt;label for="file"&gt;&lt;g:message code="book.cover.image" default="Cover Image"/&gt;&lt;/label&gt;
            &lt;input type="file" name="file" id="file" class="form-control" /&gt;
        &lt;/div&gt;
        &lt;button type="submit" class="btn btn-success"&gt;&lt;g:message code="book.save" default="Save"/&gt;&lt;/button&gt;

    &lt;/g:form&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We map the creation of the book to be handled by the <code>BookController</code> <code>save</code> action.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/UrlMappings.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">'/create'(controller: 'book', action: 'save', method: 'POST')</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/BookController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def save(CreateBookCommand cmd) {
    if ( cmd.hasErrors() ) {
        respond cmd.errors
        return
    }

    BookCurator curator = new BookCurator()
    if ( session[Oauth2CallbackController.SESSION_ATTRIBUTE_TOKEN] ) {
        curator.createdBy = session[Oauth2CallbackController.SESSION_USER_EMAIL]
        curator.createdById = session[Oauth2CallbackController.SESSION_USER_ID]
    }

    Long id = createBookWithCoverImageService.saveBookWithCover(cmd.file, curator)

    log.info "Created book ${id}"

    redirect(action: 'show', id: id)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We encapsulate the binding and validation of the cover image with a command object:</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/CreateBookCommand.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.example.getstarted.basicactions

import grails.compiler.GrailsCompileStatic
import grails.validation.Validateable

import org.springframework.web.multipart.MultipartFile

@GrailsCompileStatic
class CreateBookCommand implements Validateable {
    MultipartFile file

    static constraints = {
        file nullable: false
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_display_book">2.4. Display book</h3>
<div class="paragraph">
<p>We map the home page to be handled by the <code>BookController</code> <code>show</code> action.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/UrlMappings.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">"/read/$id"(controller: 'book', action: 'show', method: 'GET')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The controller&#8217;s action returns a list of books, along with a URL safe cursor.
It uses a service to fetch books and handles the model to the view:</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/BookController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def show(Long id) {
    log.info "Read book with id ${id}"
    [book: daoService.readBook(id)]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use a GSP to render the book:</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/views/book/show.gsp</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">&lt;%@ page import="com.example.getstarted.domain.BookGormEntity" %&gt;
&lt;%@ page import="com.example.getstarted.domain.BookLocalizationGormEntity" %&gt;
&lt;%@ page import="org.springframework.web.servlet.support.RequestContextUtils" %&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta name="layout" content="main" /&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class="container"&gt;
    &lt;h3&gt;&lt;g:message code="book" default="Book"/&gt;&lt;/h3&gt;
    &lt;div class="btn-group"&gt;
        &lt;g:link controller="book" action="edit" id="${book?.id}"  class="btn btn-primary btn-sm"&gt;
            &lt;i class="glyphicon glyphicon-edit"&gt;&lt;/i&gt;
            &lt;g:message code="book.edit" default="Edit book"/&gt;
        &lt;/g:link&gt;
        &lt;g:link controller="book" action="delete" id="${book?.id}"  class="btn btn-danger btn-sm"&gt;
            &lt;i class="glyphicon glyphicon-trash"&gt;&lt;/i&gt;
            &lt;g:message code="book.delete" default="Delete book"/&gt;
        &lt;/g:link&gt;
    &lt;/div&gt;

    &lt;div class="media"&gt;
        &lt;div class="media-left"&gt;
            &lt;img class="book-image" src="${book?.imageUrl ?: 'http://placekitten.com/g/128/192'}"&gt;
        &lt;/div&gt;
        &lt;div class="media-body"&gt;
            &lt;h4 class="book-title"&gt;&lt;bookshelf:bookTitle id="${book?.id}" languageCode="${RequestContextUtils.getLocale(request).language}"/&gt; &lt;small&gt;${book?.publishedDate}&lt;/small&gt;&lt;/h4&gt;
            &lt;h5 class="book-author"&gt;
                &lt;g:if test="${book?.author}"&gt;
                    &lt;g:message code="book.author.by" args="${[book.author]}"/&gt;
                &lt;/g:if&gt;
                &lt;g:else&gt;
                    &lt;g:message code="book.author.unknown" default="By Unknown"/&gt;
                &lt;/g:else&gt;
            &lt;/h5&gt;
            &lt;p class="book-description"&gt;&lt;bookshelf:bookDescription  id="${book?.id}" languageCode="${RequestContextUtils.getLocale(request).language}"/&gt;&lt;/p&gt;

            &lt;small&gt;Locale: ${RequestContextUtils.getLocale(request).language}&lt;/small&gt;&lt;br/&gt;

            &lt;small class="book-added-by"&gt;
                &lt;g:if test="${book?.createdBy}"&gt;
                    &lt;g:message code="book.added.by" args="${[book.createdBy]}"/&gt;
                &lt;/g:if&gt;
                &lt;g:else&gt;
                    &lt;g:message code="book.added.by.anonymous" default="Added by Anonymous"/&gt;
                &lt;/g:else&gt;
            &lt;/small&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The GSP uses a custom taglib to renders <code>title</code> or <code>description</code> depending on the current locale.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/taglib/com/example/getstarted/BookLocalizationTagLib.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.example.getstarted

import com.example.getstarted.daos.DaoService
import com.example.getstarted.objects.BookLocalization
import grails.config.Config
import grails.core.support.GrailsConfigurationAware
import groovy.util.logging.Slf4j

@Slf4j
class BookLocalizationTagLib implements GrailsConfigurationAware {

    static namespace = 'bookshelf'

    static defaultEncodeAs = [taglib: 'html']

    String defaultLanguageCode

    DaoService daoService

    def bookTitle = { args -&gt;
        String languageCode = args.languageCode ?: defaultLanguageCode
        Long bookId = args.id
        BookLocalization bookLocalization = daoService.getLocalization(bookId, languageCode)
        out &lt;&lt; bookLocalization?.title
    }

    def bookDescription = { args -&gt;
        String languageCode = args.languageCode ?: defaultLanguageCode
        Long bookId = args.id
        BookLocalization bookLocalization = daoService.getLocalization(bookId, languageCode)
        out &lt;&lt; bookLocalization?.description
    }

    @Override
    void setConfiguration(Config co) {
        defaultLanguageCode = co.getProperty('bookshelf.defaultLanguageCode', String, 'en')
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_delete_book">2.5. Delete book</h3>
<div class="paragraph">
<p>We map the home page to be handled by the <code>BookController</code> <code>show</code> action.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/UrlMappings.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">"/delete/$id"(controller: 'book', action: 'delete', method: 'GET')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The controller&#8217;s action deletes a book identify by its id.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/BookController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def delete(Long id) {
    daoService.deleteBook(id)
    redirect action: 'index'
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_edit_a_book">2.6. Edit a book</h3>
<div class="paragraph">
<p>To edit a book, we have a form which allows us to modify the metadata and/or upload a new cover image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/edit-book.png" alt="edit book">
</div>
</div>
<div class="paragraph">
<p>We map the display of the form to be handled by the <code>BookController</code> <code>edit</code> action.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/UrlMappings.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">"/update/$id"(controller: 'book', action: 'edit', method: 'GET')</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/BookController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def edit(Long id) {
    [book: daoService.readBook(id)]
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_update_a_book">2.7. Update a book</h3>
<div class="paragraph">
<p>We manage the edit form submission with the Controller&#8217;s update action.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/UrlMappings.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">"/update/$id"(controller: 'book', action: 'update', method: 'POST')</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/BookController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def update(UpdateBookCommand cmd) {
    if ( cmd.hasErrors() ) {
        return
    }
    def book = cmd as Book

    if ( (
            book.createdById == null ||
                    book.createdBy == null
         ) &amp;&amp; session[Oauth2CallbackController.SESSION_ATTRIBUTE_TOKEN] ) {
        book.createdBy = session[Oauth2CallbackController.SESSION_USER_EMAIL]
        book.createdById = session[Oauth2CallbackController.SESSION_USER_ID]
    }

    if ( cmd.file &amp;&amp; !cmd.file.isEmpty() ) {
        String fileName = uploadBookCoverService.nameForFile(cmd.file)
        String imageUrl = googleCloudStorageService.storeMultipartFile(fileName, cmd.file)
        book.imageUrl = imageUrl
    }

    daoService.updateBook(book)
    redirect(action: 'show', id: book.id)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The update methods gets a Command Object which encapsulates the parameters binding and validation</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/UpdateBookCommand.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.example.getstarted.basicactions

import com.example.getstarted.objects.Book
import com.example.getstarted.objects.BookImpl
import grails.compiler.GrailsCompileStatic
import grails.validation.Validateable
import org.springframework.web.multipart.MultipartFile

@GrailsCompileStatic
class UpdateBookCommand implements Validateable {
    Long id
    String author
    String description
    String publishedDate
    String title
    MultipartFile file
    String imageUrl
    String createdById
    String createdBy

    static constraints = {
        id nullable: false
        title nullable: false
        author nullable: true
        description nullable: true
        publishedDate nullable: true
        file nullable: true
        imageUrl nullable: true
        createdById nullable: true
        createdBy nullable: true
    }

    Object asType(Class clazz) {
        if (clazz == Book) {
            def book = new BookImpl()
            copyProperties(this, book)
            return book
        }
        super.asType(clazz)
    }

    def copyProperties(source, target) {
        source.properties.each { key, value -&gt;
            if (target.hasProperty(key as String) &amp;&amp; !(key in ['class', 'metaClass'])) {
                target[key as String] = value
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_services">3. Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you could see in the previous code snippets the business logic of the application is encapsulated in <a href="http://docs.grails.org/latest/guide/single.html#services">Grails Services</a>.</p>
</div>
<div class="sect2">
<h3 id="_configuration">3.1. Configuration</h3>
<div class="paragraph">
<p>We setup several configuration values in <code>application.yml</code> We use these configuration parameters across multiple services.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/conf/application.yml</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">org:
    grails:
        plugins:
            googlecloud:
                storage:
                    bucket: grails-bookshelf.appspot.com
---
bookshelf:
    storageType: cloudSQL
    limit: 10
    orderBy: title
    callback: http://localhost:8080/oauth2callback
    defaultLanguageCode: en
    localizations:
        - it
        - es
---</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_service_integration_overview">3.2. Service integration Overview</h3>
<div class="paragraph">
<p>Grails integrates with multiple Google Cloud Service to power the application.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/overview.png" alt="overview">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_handling_cover_image_upload">3.3. Handling Cover Image upload</h3>
<div class="listingblock">
<div class="title">app/grails-app/services/com/example/getstarted/CreateBookWithCoverImageService.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.example.getstarted

import com.example.getstarted.daos.DaoService
import com.example.getstarted.objects.BookCurator
import com.example.getstarted.objects.BookImpl
import com.example.getstarted.objects.BookLocalization
import com.example.getstarted.objects.BookLocalizationImpl
import org.grails.plugins.googlecloud.storage.GoogleCloudStorageService
import org.grails.plugins.googlecloud.vision.GoogleCloudVisionService
import org.springframework.web.multipart.MultipartFile
import groovy.transform.CompileStatic
import groovy.util.logging.Slf4j

@SuppressWarnings('GrailsStatelessService')
@Slf4j
@CompileStatic
class CreateBookWithCoverImageService {

    UploadBookCoverService uploadBookCoverService

    GoogleCloudStorageService googleCloudStorageService

    GoogleCloudVisionService googleCloudVisionService

    DaoService daoService

    BookLocalization bookLocalizationWithFile(MultipartFile file) {
        def text = googleCloudVisionService.detectDocumentText(file.inputStream)
        bookLocalizationWithText(text)
    }

    BookLocalization bookLocalizationWithText(String text) {
        if (text == null ) {
            return null
        }
        final int titleMaxSize = 255

        String title = null
        String description = null

        if ( text.size() &gt;= (titleMaxSize + 1) ) {
            title = text[0 .. (titleMaxSize - 1)]
            description = text[titleMaxSize .. (text.size() - 1)]

        } else {
            title = text
        }

        new BookLocalizationImpl(title: title, description: description)
    }

    String imageUrlWithFile(MultipartFile file) {
        String fileName = uploadBookCoverService.nameForFile(file)
        googleCloudStorageService.storeMultipartFile(fileName, file)
    }

    Long saveBookWithCover(MultipartFile file, BookCurator curator) {
        def book = new BookImpl()
        book.createdBy = curator.createdBy
        book.createdById = curator.createdById
        book.imageUrl = imageUrlWithFile(file)
        def bookLocalization = bookLocalizationWithFile(file)
        if ( bookLocalization ) {
            book.title = bookLocalization.title
            book.description = bookLocalization.description
        }
        daoService.createBook(book)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we upload a book cover image several things will happen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The cover image is uploaded to Google <a href="https://cloud.google.com/storage/">Cloud Storage</a>. This will provided use with an image url which
we will store in the database <code>book</code> table row.</p>
</li>
<li>
<p>Text in the cover image is extracted by Google <a href="https://cloud.google.com/vision/">Cloud Vision API</a>.</p>
</li>
<li>
<p>A book entry in a MySQL database provided by Google <a href="https://cloud.google.com/sql/">Cloud SQL</a>.</p>
</li>
<li>
<p>Prior to saving or updating a book, the English title and description are translated to Spanish and Italian with Google <a href="https://cloud.google.com/translate/">Cloud Translation API</a>. Those
translations are saved to the database.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_uploading_an_image_to_cloud_storage">3.4. Uploading an image to Cloud Storage</h3>
<div class="paragraph">
<p>We encapsulate the code which interacts with Google Cloud Storage in its own service:</p>
</div>
<div class="listingblock">
<div class="title">grails-googlecloud-storage/grails-app/services/org/grails/plugins/googlecloud/storage/GoogleCloudStorageService.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package org.grails.plugins.googlecloud.storage

import groovy.transform.CompileStatic

import com.google.cloud.storage.Acl
import com.google.cloud.storage.BlobId
import com.google.cloud.storage.BlobInfo
import com.google.cloud.storage.Storage
import com.google.cloud.storage.StorageOptions
import grails.config.Config
import grails.core.support.GrailsConfigurationAware
import groovy.util.logging.Slf4j
import org.springframework.web.multipart.MultipartFile

@Slf4j
@SuppressWarnings('GrailsStatelessService')
@CompileStatic
class GoogleCloudStorageService implements GrailsConfigurationAware {
    // Cloud Storage Bucket
    String bucket

    Storage storage = StorageOptions.defaultInstance.service

    String storeMultipartFile(String fileName, MultipartFile multipartFile) {
        log.info "Uploaded file ${multipartFile.originalFilename}"
        storeInputStream(fileName, multipartFile.inputStream)
    }

    String storeInputStream(String fileName, InputStream inputStream) {
        BlobInfo blobInfo = storage.create(readableBlobInfo(bucket, fileName), inputStream)
        log.info "Uploaded file as ${fileName} with mediaLink ${blobInfo.mediaLink}"

        blobInfo.mediaLink
    }

    String storeBytes(String fileName, byte[] bytes) {
        BlobInfo blobInfo = storage.create(readableBlobInfo(bucket, fileName), bytes)
        blobInfo.mediaLink
    }

    private static BlobInfo readableBlobInfo(String bucket, String fileName) {
        // Modify access list to allow all users with link to read file
        List&lt;Acl&gt; acl = [Acl.of(Acl.User.ofAllUsers(), Acl.Role.READER)]
        BlobInfo.newBuilder(bucket, fileName)
                .setAcl(acl)
                .build()
    }

    boolean deleteFile(String fileName) {
        BlobId blobId = BlobId.of(bucket, fileName)
        storage.delete(blobId)
    }

    @Override
    void setConfiguration(Config co) {
        bucket = co.getProperty('org.grails.plugins.googlecloud.storage.bucket', String)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to use Google Cloud Storage we need to add the next dependency to our compile dependencies:</p>
</div>
<div class="listingblock">
<div class="title">grails-googlecloud-storage/build.gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">    compile "com.google.cloud:google-cloud-storage:$googleCloudStorageVersion"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_extracting_the_text_of_an_image_with_cloud_vision">3.5. Extracting the text of an image with Cloud Vision</h3>
<div class="paragraph">
<p>We encapsulate the code which extracts the text in a Cover Image in a <a href="http://docs.grails.org/latest/guide/single.html#services">Grails Service</a></p>
</div>
<div class="listingblock">
<div class="title">grails-googlecloud-vision/grails-app/services/org/grails/plugins/googlecloud/vision/GoogleCloudVisionService.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package org.grails.plugins.googlecloud.vision

import com.google.cloud.vision.spi.v1.ImageAnnotatorClient
import com.google.cloud.vision.v1.AnnotateImageRequest
import com.google.cloud.vision.v1.AnnotateImageResponse
import com.google.cloud.vision.v1.BatchAnnotateImagesResponse
import com.google.cloud.vision.v1.Feature
import com.google.cloud.vision.v1.Feature.Type
import com.google.cloud.vision.v1.Image
import com.google.cloud.vision.v1.TextAnnotation
import com.google.protobuf.ByteString
import groovy.util.logging.Slf4j
import groovy.transform.CompileStatic

@Slf4j
@CompileStatic
class GoogleCloudVisionService {

    @SuppressWarnings(['ReturnNullFromCatchBlock', 'CatchException'])
    String detectDocumentText(InputStream inputStream) {
        try {
            List&lt;AnnotateImageRequest&gt; requests = []

            ByteString imgBytes = ByteString.readFrom(inputStream)

            Image img = Image.newBuilder().setContent(imgBytes).build()
            Feature feat = Feature.newBuilder().setType(Type.DOCUMENT_TEXT_DETECTION).build()
            AnnotateImageRequest request =
                    AnnotateImageRequest.newBuilder().addFeatures(feat).setImage(img).build()
            requests.add(request)

            BatchAnnotateImagesResponse response =
                    ImageAnnotatorClient.create().batchAnnotateImages(requests)
            List&lt;AnnotateImageResponse&gt; responses = response.responsesList

            List&lt;String&gt; responsesText = []
            for (AnnotateImageResponse res : responses) {
                if (res.hasError()) {
                    log.error "Error ${res.error.message}"
                    continue
                }

                TextAnnotation annotation = res.fullTextAnnotation
                responsesText &lt;&lt; annotation.text
            }

            return responsesText*.replaceAll('\n', ' ').join(' ').trim().replaceAll(' +', ' ')

        } catch ( Exception e ) {
            log.error(e.message, e)
            return null
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to use Google Cloud Vision we need to add the next dependency to our compile dependencies:</p>
</div>
<div class="listingblock">
<div class="title">grails-googlecloud-vision/build.gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">    compile "com.google.cloud:google-cloud-vision:$googleCloudVisionVersion"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Checkout <a href="https://cloud.google.com/vision/">Google Cloud Vision</a> for complete overview of the image analysis options.</p>
</div>
</div>
<div class="sect2">
<h3 id="_translate_text_with_cloud_translation_api">3.6. Translate Text with Cloud Translation API</h3>
<div class="paragraph">
<p>The next service method would be invoked with code such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">assert 'Hola Mundo' == googleCloudTranslateService.translateTextFromSourceToTarget('Hello World', 'en', 'es')</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-googlecloud-translate/grails-app/services/org/grails/plugins/googlecloud/translate/GoogleCloudTranslateService.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package org.grails.plugins.googlecloud.translate

import com.google.cloud.translate.Translate.TranslateOption
import com.google.cloud.translate.TranslateException
import com.google.cloud.translate.TranslateOptions
import groovy.transform.CompileStatic
import groovy.util.logging.Slf4j

@Slf4j
@CompileStatic
class GoogleCloudTranslateService {

    @SuppressWarnings('ReturnNullFromCatchBlock')
    String translateTextFromSourceToTarget(String text, String source, String target) {
        if ( !text ) {
            return text
        }
        try {
            return TranslateOptions.defaultInstance.service.translate(text,
                    TranslateOption.sourceLanguage(source),
                    TranslateOption.targetLanguage(target)).translatedText
        } catch (TranslateException e) {
            log.error(e.message, e)
            return null
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to use Google Cloud Translation API wee need to add the next dependency:</p>
</div>
<div class="listingblock">
<div class="title">grails-googlecloud-translate/build.gradle</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">    compile "com.google.cloud:google-cloud-translate:$googleCloudTranslateVersion"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interact_with_cloud_sql_mysql_database_with_gorm_hibernate_implementation">3.7. Interact with Cloud SQL: MySQL database with GORM Hibernate implementation</h3>
<div class="paragraph">
<p>We use <a href="http://gorm.grails.org">GORM</a>. GORM is the data access toolkit used by Grails and provides a rich set of APIs for
accessing relational and non-relational data including implementations for Hibernate (SQL), MongoDB, Neo4j, Cassandra and
an in-memory ConcurrentHashMap for testing.</p>
</div>
<div class="paragraph">
<p>We map books and localizations in a one-to-many relationship with the use of Grails Domain Classes:</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/domain/com/example/getstarted/domain/BookGormEntity.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.example.getstarted.domain

import grails.compiler.GrailsCompileStatic

@GrailsCompileStatic
class BookGormEntity {

    String author
    String createdBy
    String createdById
    String publishedDate
    String imageUrl
    static hasMany = [localizations: BookLocalizationGormEntity]

    static constraints = {
        author nullable: true, maxSize: 255
        createdBy nullable: true, maxSize: 255
        createdById nullable: true, maxSize: 255
        publishedDate nullable: true
        imageUrl    nullable: true
    }

    static mapping = {
        table 'book'
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/grails-app/domain/com/example/getstarted/domain/BookLocalizationGormEntity.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.example.getstarted.domain

import com.example.getstarted.objects.BookLocalization
import grails.compiler.GrailsCompileStatic

@GrailsCompileStatic
class BookLocalizationGormEntity implements BookLocalization {
    String title
    String description
    String languageCode
    static belongsTo = [book: BookGormEntity]

    static constraints = {
        title nullable: false, maxSize: 255
        description nullable: true
    }

    static mapping = {
        table 'book_localization'
        description type: 'text'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We encapsulate the GORM database access in a service:</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/services/com/example/getstarted/daos/CloudSqlService.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.example.getstarted.daos

import com.example.getstarted.objects.BookImpl
import org.grails.plugins.googlecloud.translate.GoogleCloudTranslateService
import com.example.getstarted.domain.BookGormEntity
import com.example.getstarted.domain.BookLocalizationGormEntity
import com.example.getstarted.objects.Book
import com.example.getstarted.objects.BookLocalization
import com.example.getstarted.objects.Result
import grails.config.Config
import grails.core.support.GrailsConfigurationAware
import grails.gorm.DetachedCriteria
import grails.transaction.Transactional
import groovy.transform.CompileStatic
import groovy.util.logging.Slf4j

@Slf4j
@SuppressWarnings('GrailsStatelessService')
@CompileStatic
@Transactional
class CloudSqlService implements BookDao, GrailsConfigurationAware {

    int limit
    String defaultLanguageCode
    List&lt;String&gt; localizations

    GoogleCloudTranslateService googleCloudTranslateService

    @Override
    void setConfiguration(Config co) {
        limit = co.getProperty('bookshelf.limit', Integer, 10)
        defaultLanguageCode = co.getProperty('bookshelf.defaultLanguageCode', String, 'en')
        localizations = co.getProperty('bookshelf.localizations', List)
    }

    @SuppressWarnings('LineLength')
    @Override
    Long createBook(Book book) {
        BookGormEntity entity = new BookGormEntity()
        populateEntityWithBook(entity, book)
        if ( book.title != null ) {
            entity.addToLocalizations(new BookLocalizationGormEntity(languageCode: defaultLanguageCode,
                    title: book.title,
                    description: book.description))

            for (String languageCode : localizations ) {
                String title = googleCloudTranslateService.translateTextFromSourceToTarget(book.title, defaultLanguageCode, languageCode)
                String description = googleCloudTranslateService.translateTextFromSourceToTarget(book.description, defaultLanguageCode, languageCode)
                entity.addToLocalizations(new BookLocalizationGormEntity(languageCode: languageCode,
                        title: title,
                        description: description))
            }
        }

        entity.save()
        entity.id
    }

    @Transactional(readOnly = true)
    @Override
    Book readBook(Long bookId) {
        def entity = BookGormEntity.get(bookId)
        def book = new BookImpl()
        book.with {
            id = entity.id
            author = entity.author
            createdBy = entity.createdById
            createdById = entity.createdById
            publishedDate = entity.publishedDate
            imageUrl = entity.imageUrl
        }
        BookLocalization bookLocalization = getLocalization(bookId, defaultLanguageCode)
        book.title = bookLocalization?.title
        book.description = bookLocalization?.description
        book
    }

    @SuppressWarnings('LineLength')
    @Override
    void updateBook(Book book) {
        def entity = BookGormEntity.get(book.id)
        populateEntityWithBook(entity, book)
        addOrUpdateBookLocalizationWithTitleAndDescriptionByLanguageCode(entity, defaultLanguageCode, book.title, book.description)

        for (String languageCode : localizations ) {
            String title = googleCloudTranslateService.translateTextFromSourceToTarget(book.title, defaultLanguageCode, languageCode)
            String description = googleCloudTranslateService.translateTextFromSourceToTarget(book.description, defaultLanguageCode, languageCode)
            addOrUpdateBookLocalizationWithTitleAndDescriptionByLanguageCode(entity, languageCode, title, description)
        }

        entity.save()
    }

    @SuppressWarnings('LineLength')
    static void addOrUpdateBookLocalizationWithTitleAndDescriptionByLanguageCode(BookGormEntity entity, String languageCode, String title, String description) {
        BookLocalizationGormEntity defaultBookLocalizationGormEntity = entity.localizations.find { it.languageCode == languageCode }
        if ( defaultBookLocalizationGormEntity ) {
            defaultBookLocalizationGormEntity.title = title
            defaultBookLocalizationGormEntity.description = description
        } else {
            entity.addToLocalizations(new BookLocalizationGormEntity(languageCode: languageCode,
                    title: title,
                    description: description))
        }
    }

    @Override
    void deleteBook(Long bookId) {
        def entity = BookGormEntity.get(bookId)
        entity?.delete()
    }

    @Transactional(readOnly = true)
    @Override
    Result&lt;Book&gt; listBooks(String cursor) {
        def query = listBooksQuery()
        listBooksByQuery(cursor, query)
    }

    @Transactional(readOnly = true)
    @Override
    Result&lt;Book&gt; listBooksByUser(String userId, String cursor) {
        def query = listBooksByUserQuery(userId)
        listBooksByQuery(cursor, query)
    }

    @Transactional(readOnly = true)
    @Override
    BookLocalization getLocalization(Long bookId, String code) {
        String language = code ?: defaultLanguageCode
        def q = BookLocalizationGormEntity.where { book.id == bookId &amp;&amp; languageCode == language }
        log.info 'code: ' + code + 'size: ' + q.list().size()
        q.get()
    }

    private DetachedCriteria&lt;BookGormEntity&gt; listBooksQuery() {
        BookGormEntity.where { }
    }

    private DetachedCriteria&lt;BookGormEntity&gt; listBooksByUserQuery(String userId) {
        BookGormEntity.where { createdById == userId }
    }

    private Result&lt;Book&gt; listBooksByQuery(String cursor, DetachedCriteria&lt;BookGormEntity&gt; query) {
        def offset = cursor ? Integer.parseInt(cursor) : 0
        def max = limit
        int total = query.count() as int
        def booksEntities = query.max(max).offset(offset).list()
        def books = collectBooks(booksEntities)
        if (total &gt; (offset + limit)) {
            return new Result&lt;&gt;(books, Integer.toString(offset + limit))
        }
        new Result&lt;&gt;(books)
    }

    private List&lt;Book&gt; collectBooks(List&lt;BookGormEntity&gt; entities) {
        entities.collect { BookGormEntity entity -&gt;
            BookImpl book = new BookImpl()

            BookLocalization bookLocalization = getLocalization(entity.id, defaultLanguageCode)
            book.with {
                id = entity.id
                author = entity.author
                createdBy = entity.createdBy
                createdById = entity.createdById
                publishedDate = entity.publishedDate
                imageUrl = entity.imageUrl
                title = bookLocalization?.title
                description = bookLocalization?.description
            }
            book
        } as List&lt;Book&gt;
    }

    private static void populateEntityWithBook(BookGormEntity entity, Book book) {
        entity.with {
            author = book.author
            createdBy = book.createdBy
            createdById = book.createdById
            publishedDate = book.publishedDate
            imageUrl = book.imageUrl
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authenticating_users_with_grails">4. Authenticating Users with Grails</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This part of the Bookshelf tutorial for Java shows how to create a sign-in flow for users and how to use profile information to provide users with personalized functionality.</p>
</div>
<div class="paragraph">
<p>By using <a href="https://developers.google.com/identity/">Google Identity Platform</a>, you can easily access information about your users while ensuring their sign-in
credentials are safely managed by Google. <a href="https://developers.google.com/identity/protocols/OpenIDConnect">OAuth 2.0</a> makes it easy to provide a sign-in flow for all
users of your app and provides your application with access to basic profile information about authenticated users.</p>
</div>
<div class="sect2">
<h3 id="_creating_a_web_application_client_id">4.1. Creating a web application client ID</h3>
<div class="paragraph">
<p>A web application client ID allows your application to authorize users and access Google APIs on behalf of your users.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Go to the <a href="https://console.cloud.google.com/apis/credentials?_ga=1.16303478.1963584502.1488379440">credentials section in the Google Cloud Platform Console</a>.</p>
</li>
<li>
<p>Click <strong>OAuth consent screen</strong>. For the the product name, enter <code>Java Bookshelf App</code>. Fill in any relevant optional fields. Click <strong>Save</strong>.</p>
</li>
<li>
<p>Click <strong>Create credentials &gt; OAuth client ID</strong>.</p>
</li>
<li>
<p>Under <strong>Application type</strong>, select <strong>Web Application</strong>.</p>
</li>
<li>
<p>Under <strong>Name</strong>, enter <code>Java Bookshelf Client</code>.</p>
</li>
<li>
<p>Under <strong>Authorized redirect URIs</strong> enter the following URLs, one at a time. Replace <code>[YOUR_PROJECT_ID]</code> with your project ID:
<code><a href="http://localhost:8080/oauth2callback" class="bare">http://localhost:8080/oauth2callback</a></code>
<code>http://[YOUR_PROJECT_ID].appspot.com/oauth2callback</code>
<code>https://[YOUR_PROJECT_ID].appspot.com/oauth2callback</code>
<code>http://[YOUR_PROJECT_ID].appspot-preview.com/oauth2callback</code>
https://[YOUR_PROJECT_ID].appspot-preview.com/oauth2callback`</p>
</li>
<li>
<p>Click <strong>Create</strong>.</p>
</li>
<li>
<p>Copy the <strong>client ID</strong> and <strong>client secret</strong> and save them for later use.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_settings">4.2. Configuring settings</h3>
<div class="paragraph">
<p>In the <code>app/grails-app/conf/</code> directory, open <code>application-production.yml</code> for editing.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set <code>bookshelf.callback</code> to <code>[YOUR_PROJECT_ID].appspot.com//auth2callback</code>.</p>
</li>
<li>
<p>Set <code>bookshelf.clientID</code> to the client ID you created previously.</p>
</li>
<li>
<p>Set <code>bookshelf.clientSecret</code> to the client secret you created previously.</p>
</li>
<li>
<p>Save and close <code>application-production.yml</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_application_structure">4.3. Application structure</h3>
<div class="paragraph">
<p>The following diagram shows the application&#8217;s components and how they connect to one another.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/java-auth.png" alt="java auth">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_understanding_the_code">4.4. Understanding the code</h3>
<div class="paragraph">
<p>This section walks you through the application code and explains how it works.</p>
</div>
<div class="paragraph">
<p>The <code>LoginController</code> is invoked when the user clicks <strong>Login</strong>.</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/LoginController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.example.getstarted.basicactions

import grails.config.Config
import grails.core.support.GrailsConfigurationAware
import groovy.transform.CompileStatic
import groovy.util.logging.Slf4j
import org.grails.plugins.googlecloud.authorization.GoogleAuthorizationService

@Slf4j
@CompileStatic
class LoginController implements GrailsConfigurationAware {

    static allowedMethods = [index: 'GET']
    public static final String SESSION_ATTRIBUTE_STATE = 'state'
    public static final String SESSION_ATTRIBUTE_LOGIN_DESTINATION = 'loginDestination'

    String defaultLoginDestination

    GoogleAuthorizationService googleAuthorizationService

    def index(String loginDestination) {
        String state = googleAuthorizationService.randomState() <i class="conum" data-value="1"></i><b>(1)</b>
        def url = googleAuthorizationService.authorizationRedirectUrl(state)
        session.setAttribute(SESSION_ATTRIBUTE_STATE, state)
        String destination = loginDestination ?: defaultLoginDestination
        log.info "logging destination $destination"
        session.setAttribute(SESSION_ATTRIBUTE_LOGIN_DESTINATION, destination) <i class="conum" data-value="2"></i><b>(2)</b>
        redirect(url: url)
    }

    @Override
    void setConfiguration(Config co) {
        defaultLoginDestination = co.getProperty('bookshelf.loginDestination', String, '/books')
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It does the following:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Save some random <em>state</em> to help <a href="https://developers.google.com/identity/protocols/OpenIDConnect#authenticationuriparameters">prevent request forgeries</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Save the destination of where to go after sign in.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A service encapsulates the interaction with <a href="https://developers.google.com/api-client-library/java/google-api-java-client/reference/1.19.1/?overview-summary.html">Google API Client Library</a>,
specifically <a href="https://developers.google.com/api-client-library/java/google-api-java-client/reference/1.19.1/com/google/api/client/googleapis/auth/oauth2/GoogleAuthorizationCodeFlow.html">GoogleAuthorizationCodeFlow</a>.
to generate a callback request to Google to handle signing in to a Google account. This app specifies the "email" and "profile" scopes, so it can display the user&#8217;s email and image on each page:</p>
</div>
<div class="listingblock">
<div class="title">grails-googlecloud-authorization/grails-app/services/org/grails/plugins/googlecloud/authorization/GoogleAuthorizationService.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package org.grails.plugins.googlecloud.authorization

import com.fasterxml.jackson.databind.ObjectMapper

import com.google.api.client.auth.oauth2.Credential
import com.google.api.client.auth.oauth2.TokenResponse
import com.google.api.client.googleapis.auth.oauth2.GoogleAuthorizationCodeFlow
import com.google.api.client.http.GenericUrl
import com.google.api.client.http.HttpRequest
import com.google.api.client.http.HttpRequestFactory
import com.google.api.client.http.HttpTransport
import com.google.api.client.http.javanet.NetHttpTransport
import com.google.api.client.json.JsonFactory
import com.google.api.client.json.jackson.JacksonFactory
import grails.config.Config
import grails.core.support.GrailsConfigurationAware
import java.security.SecureRandom
import groovy.transform.CompileStatic

@SuppressWarnings('GrailsStatelessService')
@CompileStatic
class GoogleAuthorizationService implements GrailsConfigurationAware {
    private static final String USERINFO_ENDPOINT = 'https://www.googleapis.com/plus/v1/people/me/openIdConnect'

    private static final HttpTransport HTTP_TRANSPORT = new NetHttpTransport()
    private static final Collection&lt;String&gt; SCOPES = ['email', 'profile']
    private static final JsonFactory JSON_FACTORY = new JacksonFactory()

    String clientID
    String clientSecret
    String callback

    static String randomState() {
        new BigInteger(130, new SecureRandom()).toString(32)
    }

    /**
     *
     * @param state - Used to prevent request forgery
     * @return
     */
    String authorizationRedirectUrl(String state) {
        def flow = new GoogleAuthorizationCodeFlow.Builder(
                HTTP_TRANSPORT,
                JSON_FACTORY,
                clientID,
                clientSecret,
                SCOPES)
                .build()
        flow.newAuthorizationUrl()
                .setRedirectUri(callback)
                .setState(state)            // Prevent request forgery
                .build()
    }

    GoogleAuthorizationCodeFlow flow() {
        new GoogleAuthorizationCodeFlow.Builder(
                HTTP_TRANSPORT,
                JSON_FACTORY,
                clientID,
                clientSecret,
                SCOPES).build()
    }

    TokenResponse tokenResponse(GoogleAuthorizationCodeFlow flow, String authorizationCode) {
        flow.newTokenRequest(authorizationCode)
                .setRedirectUri(callback)
                .execute()
    }

    Map&lt;String, String&gt; useIdResultForTokenResponse(GoogleAuthorizationCodeFlow flow, TokenResponse tokenResponse) {
        final Credential credential = flow.createAndStoreCredential(tokenResponse, null)
        final HttpRequestFactory requestFactory = HTTP_TRANSPORT.createRequestFactory(credential)
        final GenericUrl url = new GenericUrl(USERINFO_ENDPOINT)      // Make an authenticated request.
        final HttpRequest request = requestFactory.buildGetRequest(url)
        request.headers.contentType = 'application/json'
        final String jsonIdentity = request.execute().parseAsString()
        new ObjectMapper().readValue(jsonIdentity, HashMap)
    }

    @Override
    void setConfiguration(Config co) {
        clientID = co.getRequiredProperty('bookshelf.clientID', String)
        clientSecret = co.getRequiredProperty('bookshelf.clientSecret', String)
        callback = co.getRequiredProperty('bookshelf.callback', String)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Google redirects the user to the <code>/oauth2callback</code> URL. After the user successfully signs in, the <code>Oauth2CallbackController</code> <code>index</code> method does the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check that its not a forgery by comparing our <code>state</code> with the saved session <code>state</code>.</p>
</li>
<li>
<p>Delete the saved session <code>state</code>.</p>
</li>
<li>
<p>Get the response <code>tokenResponse</code>.</p>
</li>
<li>
<p>Use the <code>tokenResponse</code> to get a <code>Credential</code>.</p>
</li>
<li>
<p>Use the <code>credential</code> to create a <code>requestFactory</code>.</p>
</li>
<li>
<p>Use the <code>request</code> to get the <code>jsonIdentity</code>.</p>
</li>
<li>
<p>Extract email, a picture, and an ID.</p>
</li>
<li>
<p>Redirect to the saved <code>loginDestination</code> from the prior step.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/Oauth2CallbackController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.example.getstarted.basicactions

import com.google.api.client.auth.oauth2.TokenResponse
import grails.config.Config
import grails.core.support.GrailsConfigurationAware
import groovy.transform.CompileStatic
import groovy.util.logging.Slf4j
import org.grails.plugins.googlecloud.authorization.GoogleAuthorizationService

import javax.servlet.http.HttpServletResponse

@Slf4j
@CompileStatic
class Oauth2CallbackController implements GrailsConfigurationAware {
    static allowedMethods = [index: 'GET']

    public static final String SESSION_ATTRIBUTE_TOKEN = 'token'
    public static final String SESSION_USER_ID = 'userId'
    public static final String SESSION_USER_EMAIL = 'userEmail'
    public static final String SESSION_USER_IMAGE_URL = 'userImageUrl'

    String defaultLoginDestination

    GoogleAuthorizationService googleAuthorizationService

    @SuppressWarnings('LineLength')
    def index(String state, String code) {

        // Ensure that this is no request forgery going on, and that the user
        // sending us this connect request is the user that was supposed to.
        if ( session[LoginController.SESSION_ATTRIBUTE_STATE] == null || !(state == session[LoginController.SESSION_ATTRIBUTE_STATE])) {
            response.status = HttpServletResponse.SC_UNAUTHORIZED
            redirect(uri: defaultLoginDestination)
            return
        }

        session.removeAttribute(LoginController.SESSION_ATTRIBUTE_STATE)     // Remove one-time use state.

        def flow = googleAuthorizationService.flow()
        final TokenResponse tokenResponse = googleAuthorizationService.tokenResponse(flow, code)

        session[SESSION_ATTRIBUTE_TOKEN] = tokenResponse.toString() // Keep track of the token.

        Map&lt;String, String&gt; userIdResult = googleAuthorizationService.useIdResultForTokenResponse(flow, tokenResponse)

        // From this map, extract the relevant profile info and store it in the session.
        session[SESSION_USER_EMAIL] = userIdResult['email']
        session[SESSION_USER_ID] = userIdResult['sub']
        session[SESSION_USER_IMAGE_URL] = userIdResult['picture']
        def destination = session[LoginController.SESSION_ATTRIBUTE_LOGIN_DESTINATION]
        log.info "Login successful, redirecting to $destination"
        redirect(uri: destination)
    }

    @Override
    void setConfiguration(Config co) {
        defaultLoginDestination = co.getProperty('bookshelf.loginDestination', String, '/books')
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>LogoutController</code> deletes the <code>session</code> and creates a new one:</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/LogoutController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package com.example.getstarted.basicactions

import groovy.transform.CompileStatic

@CompileStatic
class LogoutController {

    static allowedMethods = [index: 'GET']

    def index() {
        session.invalidate()
        redirect(controller: 'book', action: 'index')
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_logging_application_events_with_grails">5. Logging Application Events with Grails</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This part of the Bookshelf tutorial for Grails shows how an app can incorporate detailed logging to help with detecting, debugging, and monitoring potential issues.</p>
</div>
<div class="sect2">
<h3 id="_viewing_logs">5.1. Viewing logs</h3>
<div class="paragraph">
<p>As the bookshelf app runs, it writes logging data that is collected and made available in the Cloud Platform Console. You can use the <a href="https://console.cloud.google.com/logs?_ga=1.80399703.1963584502.1488379440">log monitoring tools</a> in the Cloud Platform Console to analyze the logs directly. If you want more detailed analysis, you can use the Cloud Platform Console to stream or import the app&#8217;s logs into <a href="https://cloud.google.com/logging/docs/install/logs_export">BigQuery</a> or export them to a <a href="https://cloud.google.com/logging/docs/install/logs_export">Cloud Storage Bucket</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/dev-console-log-monitor.png" alt="dev console log monitor">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_application_structure_2">5.2. Application structure</h3>
<div class="paragraph">
<p>The following diagram shows how the app handles logging when deployed to the App Engine flexible environment.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/java-logs-gae.png" alt="java logs gae">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_understanding_the_code_2">5.3. Understanding the code</h3>
<div class="paragraph">
<p>There are many Java logging packages that are compatible with the App Engine flexible environment.
Grails 3 uses <a href="http://logback.qos.ch/">Logback logging framework</a></p>
</div>
<div class="paragraph">
<p>Grails artefacts (Controllers, Services &#8230;&#8203;) get injected a <code>log</code> property automatically. For any other class, you can inject a <code>org.slf4j.Logger log</code> property
in any Groovy Class with the  <a href="http://docs.groovy-lang.org/latest/html/gapi/groovy/util/logging/Slf4j.html">@Slf4j Local Transformation</a>.</p>
</div>
<div class="paragraph">
<p>You can use the methods <code>debug</code>, <code>info</code>, <code>warn</code>, or <code>error</code> to log with different levels: <code>DEBUG</code>, <code>INFO</code>, <code>WARNING</code>, and <code>ERROR</code>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="title">app/grails-app/controllers/com/example/getstarted/basicactions/BookController.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">    def show(Long id) {
        log.info "Read book with id ${id}"
        [book: daoService.readBook(id)]
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Logging configuration can be configured in the <code>grails-app/conf/logback.groovy</code> file.</p>
</div>
</div>
<div class="sect2">
<h3 id="_understanding_the_logging_configuration">5.4. Understanding the logging configuration</h3>
<div class="paragraph">
<p>When the sample app runs in the App Engine flexible environment, anything logged to <code>stderr</code> and <code>stdout</code> is automatically collected by Cloud Logging and
available for viewing, searching, and exporting in the <a href="https://console.cloud.google.com/logs?_ga=1.79946327.1963584502.1488379440">logs viewer in the Cloud Platform Console</a>.</p>
</div>
<div class="paragraph">
<p>In this sample, all logs are written to <code>stderr</code>/<code>stdout</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cleaning_up">6. Cleaning up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To avoid incurring charges to your Google Cloud Platform account for the resources used in this tutorial:</p>
</div>
<div class="sect2">
<h3 id="_delete_the_project">6.1. Delete the project</h3>
<div class="paragraph">
<p>The easiest way to eliminate billing is to delete the project you created for the tutorial.</p>
</div>
<div class="paragraph">
<p>To delete the project:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Cloud Platform Console, go to the Projects page.
<a href="https://console.cloud.google.com/iam-admin/projects?_ga=1.77720276.1963584502.1488379440">GO TO THE PROJECTS PAGE</a></p>
</li>
<li>
<p>In the project list, select the project you want to delete and click <strong>Delete project</strong>.<br></p>
</li>
<li>
<p>In the dialog, type the project ID, and then click Shut down to delete the project.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/delete-project-screenshot.png" alt="delete project screenshot">
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Deleting a project has the following consequences:<br>
If you used an existing project, you&#8217;ll also delete any other work you&#8217;ve done in the project.<br>
You can&#8217;t reuse the project ID of a deleted project. If you created a custom project ID that you plan to
use in the future, you should delete the resources inside the project instead. This ensures that URLs that
use the project ID, such as an appspot.com URL, remain available.<br>
If you are exploring multiple tutorials and quickstarts, reusing projects instead of deleting them prevents you from exceeding project quota limits.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_delete_non_default_versions_of_your_app">6.2. Delete non-default versions of your app</h3>
<div class="paragraph">
<p>If you don&#8217;t want to delete your project, you can reduce costs by deleting the non-default versions of your app.</p>
</div>
<div class="paragraph">
<p>To delete an app version:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Cloud Platform Console, go to the App Engine Versions page.
<a href="https://console.cloud.google.com/appengine/versions?_ga=1.121892171.1963584502.1488379440">GO TO THE VERSIONS PAGE</a></p>
</li>
<li>
<p>Click the checkbox next to the non-default app version you want to delete.
You can overwrite the default version of your app by redeploying the app.**</p>
</li>
<li>
<p>Click the Delete button at the top of the page to delete the app version.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The only way to delete the default version of your App Engine app is to delete your project. You can, however, stop the default version in the Cloud Platform Console. This will shut down all instances associated with the version. You can restart these instances later if needed.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_delete_your_cloud_storage_bucket">6.3. Delete your Cloud Storage bucket</h3>
<div class="paragraph">
<p>To delete a Cloud Storage bucket:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Cloud Platform Console, go to the Cloud Storage browser.
<a href="https://console.cloud.google.com/storage/browser?_ga=1.11738740.1963584502.1488379440">GO TO THE CLOUD STORAGE BROWSER</a></p>
</li>
<li>
<p>Click the checkbox next to the bucket you want to delete.</p>
</li>
<li>
<p>Click the <strong>Delete</strong> button at the top of the page to delete the bucket.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-04-27 13:36:25 UTC
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
<script>prettyPrint()</script>
</body>
</html>